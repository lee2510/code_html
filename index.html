<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Geth Wallet Manager</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #4B5EAA 0%, #6B7280 100%);
      min-height: 100vh;
      padding: 20px;
      color: #1F2937;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    .card { 
      background: #FFFFFF; 
      border-radius: 16px; 
      padding: 30px; 
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    input, button, select { 
      width: 100%; 
      padding: 12px 16px; 
      border-radius: 8px; 
      border: 2px solid #D1D5DB;
      font-size: 14px;
      margin-bottom: 12px;
      transition: all 0.3s;
    }
    input:focus { border-color: #6366F1; outline: none; }
    button { 
      background: linear-gradient(135deg, #4B5EAA 0%, #6366F1 100%);
      color: #FFFFFF; 
      border: none; 
      cursor: pointer;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(75,94,170,0.3); }
    button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    button.secondary { background: #E5E7EB; color: #1F2937; }
    button.danger { background: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%); }
    button.success { background: linear-gradient(135deg, #0D9488 0%, #047857 100%); }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .tab { 
      flex: 1; 
      min-width: 120px;
      padding: 14px 20px; 
      background: #E5E7EB; 
      border: none; 
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      color: #1F2937;
      transition: all 0.3s;
    }
    .tab.active { 
      background: linear-gradient(135deg, #4B5EAA 0%, #6366F1 100%);
      color: #FFFFFF;
      box-shadow: 0 5px 15px rgba(75,94,170,0.3);
    }
    .message { 
      padding: 15px; 
      border-radius: 10px; 
      margin-top: 15px;
      animation: slideIn 0.3s;
    }
    @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .message.success { background: #D1FAE5; color: #065F46; border-left: 4px solid #0D9488; }
    .message.error { background: #FEE2E2; color: #991B1B; border-left: 4px solid #DC2626; }
    .message.info { background: #FEF3C7; color: #92400E; border-left: 4px solid #F59E0B; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th { background: #F3F4F6; padding: 12px; text-align: left; font-weight: 600; color: #1F2937; }
    td { padding: 12px; border-bottom: 1px solid #E5E7EB; font-size: 13px; color: #4B5563; }
    tr:hover { background: #F9FAFB; }
    .header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 10px;
      flex-wrap: wrap;
      gap: 15px;
    }
    .balance-display { 
      font-size: 32px; 
      font-weight: bold; 
      color: #4B5EAA;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    .address { 
      font-family: 'Courier New', monospace; 
      font-size: 12px; 
      color: #6B7280;
      word-break: break-all;
    }
    .log-entry { 
      background: #F3F4F6; 
      padding: 12px; 
      margin-bottom: 8px; 
      border-radius: 8px;
      border-left: 4px solid #6366F1;
    }
    .log-header { 
      display: flex; 
      justify-content: space-between; 
      margin-bottom: 8px;
      font-weight: 600;
      color: #1F2937;
    }
    .log-data { 
      font-size: 12px; 
      color: #4B5563; 
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: bold;
    }
    .status-success { background: #0D9488; color: #FFFFFF; }
    .status-failed { background: #DC2626; color: #FFFFFF; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      animation: fadeIn 0.3s;
    }
    .modal.show { display: flex; align-items: center; justify-content: center; }
    .modal-content {
      background: #FFFFFF;
      border-radius: 16px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      animation: slideUp 0.3s;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #E5E7EB;
    }
    .modal-close {
      background: #E5E7EB;
      border: none;
      width: 35px;
      height: 35px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      line-height: 1;
      margin: 0;
    }
    .modal-close:hover { background: #D1D5DB; transform: none; }
    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #F3F4F6;
    }
    .detail-label { color: #6B7280; font-weight: 600; }
    .detail-value { color: #1F2937; font-weight: 500; text-align: right; word-break: break-all; }
    .search-box {
      position: relative;
      margin-bottom: 15px;
    }
    .search-box input {
      padding-right: 100px;
    }
    .search-box button {
      position: absolute;
      right: 5px;
      top: 5px;
      width: auto;
      padding: 8px 15px;
      margin: 0;
    }
    .gas-fee-box {
      background: #F3F4F6;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }
    .gas-fee-row {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      font-size: 14px;
    }
    .gas-fee-row.total {
      font-weight: bold;
      font-size: 16px;
      color: #4B5EAA;
      padding-top: 10px;
      margin-top: 10px;
      border-top: 2px solid #D1D5DB;
    }
    .copy-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #6366F1;
      color: white;
      border: none;
      width: 28px;
      height: 28px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-left: 8px;
      transition: all 0.3s;
      padding: 0;
    }
    .copy-btn:hover {
      background: #4F46E5;
      transform: scale(1.1);
    }
    .copy-btn.copied {
      background: #0D9488;
    }
    .chart-container {
      position: relative;
      height: 300px;
      margin-top: 20px;
    }
    @media (max-width: 768px) {
      .grid-2 { grid-template-columns: 1fr; }
      .header { flex-direction: column; text-align: center; }
    }
    h1, h2 { margin-bottom: 15px; color: #1F2937; }
    h1 { font-size: 28px; }
    h2 { font-size: 20px; }
    .loading { text-align: center; padding: 40px; color: #F3F4F6; font-size: 18px; }
  </style>
</head>
<body>
  <div id="app" class="container">
    <div class="loading">‚è≥ ƒêang kh·ªüi t·∫°o v√≠...</div>
  </div>

  <!-- Modal chi ti·∫øt giao d·ªãch -->
  <div id="txDetailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üìã Chi ti·∫øt giao d·ªãch</h2>
        <button class="modal-close" onclick="closeModal()">‚úï</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <script>
    const GETH_RPC = 'http://127.0.0.1:8545';
    let web3;
    let currentAccount = null;
    let currentPage = 'login';

    // L∆∞u l·ªãch s·ª≠ s·ªë d∆∞
    function saveBalanceHistory(address, balance) {
      const historyKey = `balanceHistory_${address}`;
      let history = JSON.parse(localStorage.getItem(historyKey) || '[]');
      
      const now = new Date().toISOString();
      const lastEntry = history.atat(history.length - 11);
      
      // Ch·ªâ l∆∞u n·∫øu s·ªë d∆∞ thay ƒë·ªïi ho·∫∑c ƒë√£ qua 1 ph√∫t
      if (!lastEntry || 
          lastEntry.balance !== balance || 
          (new Date(now) - new Date(lastEntry.timestamp)) > 60000) {
        history.push({
          balance: Number.parseFloat(balance),
          timestamp: now
        });
        
        // Gi·ªõi h·∫°n 100 ƒëi·ªÉm d·ªØ li·ªáu
        if (history.length > 100) {
          history = history.slice(-100);
        }
        
        localStorage.setItem(historyKey, JSON.stringify(history));
      }
    }

    // L·∫•y l·ªãch s·ª≠ s·ªë d∆∞
    function getBalanceHistory(address) {
      const historyKey = `balanceHistory_${address}`;
      return JSON.parse(localStorage.getItem(historyKey) || '[]');
    }

    // Kh·ªüi t·∫°o Web3
    async function initWeb3() {
      try {
        web3 = new Web3(new Web3.providers.HttpProvider(GETH_RPC));
        const networkId = await web3.eth.net.getId();
        console.log('‚úÖ K·∫øt n·ªëi Geth th√†nh c√¥ng - Network ID:', networkId);
        return true;
      } catch (err) {
        console.error('‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi Geth:', err);
        return false;
      }
    }

    // Ghi log v√†o localStorage
    function logToBackend(event, data) {
      const logs = JSON.parse(localStorage.getItem('gethLogs') || '[]');
      logs.unshift({
        event,
        data,
        timestamp: new Date().toISOString()
      });
      localStorage.setItem('gethLogs', JSON.stringify(logs.slice(0, 100)));
      console.log(`[GETH LOG] ${event}:`, data);
    }

    // T·∫°o t√†i kho·∫£n m·ªõi
    async function createAccount(password) {
      try {
        const account = web3.eth.accounts.create();
        const encrypted = web3.eth.accounts.encrypt(account.privateKey, password);
        
        logToBackend('ACCOUNT_CREATED', {
          address: account.address,
          timestamp: new Date().toISOString()
        });

        return { address: account.address, encrypted: JSON.stringify(encrypted) };
      } catch (err) {
        throw new Error('Kh√¥ng th·ªÉ t·∫°o t√†i kho·∫£n: ' + err.message);
      }
    }

    // Import account dev t·ª´ Geth
    async function importDevAccount() {
      try {
        const accounts = await web3.eth.getAccounts();
        if (!accounts || accounts.length === 0) {
          throw new Error('Kh√¥ng c√≥ account Geth! Ch·∫°y: geth --dev --http --http.api eth,net,web3,personal');
        }

        const devAddress = accounts[0];
        const balance = await web3.eth.getBalance(devAddress);
        
        logToBackend('DEV_ACCOUNT_IMPORTED', {
          address: devAddress,
          balance: web3.utils.fromWei(balance, 'ether') + ' ETH',
          timestamp: new Date().toISOString()
        });

        return {
          address: devAddress,
          balance: web3.utils.fromWei(balance, 'ether'),
          type: 'dev'
        };
      } catch (err) {
        throw new Error('L·ªói import dev account: ' + err.message);
      }
    }

    // T·∫°o test account v·ªõi 100 ETH
    async function createTestAccount() {
      try {
        const accounts = await web3.eth.getAccounts();
        if (!accounts || accounts.length === 0) {
          throw new Error('Kh√¥ng c√≥ account Geth! Ch·∫°y: geth --dev --http --http.api eth,net,web3');
        }

        const newAccount = web3.eth.accounts.create();
        const password = '123456';
        const encrypted = web3.eth.accounts.encrypt(newAccount.privateKey, password);

        // Chuy·ªÉn 100 ETH t·ª´ account Geth m·∫∑c ƒë·ªãnh
        const txHash = await web3.eth.sendTransaction({
          from: accounts[0],
          to: newAccount.address,
          value: web3.utils.toWei('100', 'ether'),
          gas: 21000
        });

        logToBackend('TEST_ACCOUNT_CREATED', {
          address: newAccount.address,
          fundedWith: '100 ETH',
          txHash: txHash.transactionHash,
          timestamp: new Date().toISOString()
        });

        return { 
          address: newAccount.address, 
          encrypted: JSON.stringify(encrypted),
          password 
        };
      } catch (err) {
        throw new Error('L·ªói t·∫°o test account: ' + err.message);
      }
    }

    // Ki·ªÉm tra s·ªë d∆∞
    async function getBalance(address) {
      try {
        const balance = await web3.eth.getBalance(address);
        return web3.utils.fromWei(balance, 'ether');
      } catch (err) {
        throw new Error('Kh√¥ng th·ªÉ l·∫•y s·ªë d∆∞: ' + err.message);
      }
    }

    // T√≠nh gas fee
    async function estimateGasFee(fromAddress, toAddress, amount) {
      try {
        const valueWei = web3.utils.toWei(amount.toString(), 'ether');
        const gasPrice = await web3.eth.getGasPrice();
        const gasLimit = 21000;
        const gasFeeWei = BigInt(gasPrice) * BigInt(gasLimit);
        const gasFeeEth = web3.utils.fromWei(gasFeeWei.toString(), 'ether');
        
        return {
          gasPrice: web3.utils.fromWei(gasPrice, 'gwei'),
          gasLimit,
          gasFee: gasFeeEth,
          total: (Number.parseFloat(amount) + Number.parseFloat(gasFeeEth)).toFixed(6)
        };
      } catch (err) {
        throw new Error('Kh√¥ng th·ªÉ t√≠nh gas fee: ' + err.message);
      }
    }

    // G·ª≠i giao d·ªãch (h·ªó tr·ª£ c·∫£ dev account v√† encrypted account)
    async function sendTransaction(fromAddress, toAddress, amount, password) {
      try {
        const accounts = JSON.parse(localStorage.getItem('walletAccounts') || '[]');
        const account = accounts.find(a => a.address.toLowerCase() === fromAddress.toLowerCase());
        
        if (!account) throw new Error('Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n!');

        const valueWei = web3.utils.toWei(amount.toString(), 'ether');
        const balance = await web3.eth.getBalance(fromAddress);
        const gasPrice = await web3.eth.getGasPrice();
        const gasLimit = 21000;
        const gasFeeWei = BigInt(gasPrice) * BigInt(gasLimit);
        const totalWei = BigInt(valueWei) + gasFeeWei;
        
        if (BigInt(balance) < totalWei) {
          throw new Error(`S·ªë d∆∞ kh√¥ng ƒë·ªß (c·∫ßn ${web3.utils.fromWei(totalWei.toString(), 'ether')} ETH, c√≥ ${web3.utils.fromWei(balance, 'ether')} ETH)`);
        }

        let receipt;

        // N·∫øu l√† dev account th√¨ g·ª≠i tr·ª±c ti·∫øp qua Geth
        if (account.type === 'dev') {
          const tx = {
            from: fromAddress,
            to: toAddress,
            value: valueWei,
            gas: gasLimit,
            gasPrice: gasPrice
          };

          receipt = await web3.eth.sendTransaction(tx);
        } else {
          // Account th∆∞·ªùng c·∫ßn decrypt
          let decrypted;
          try {
            decrypted = web3.eth.accounts.decrypt(JSON.parse(account.encrypted), password);
          } catch {
            throw new Error('M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!');
          }

          const tx = {
            from: fromAddress,
            to: toAddress,
            value: valueWei,
            gas: gasLimit,
            gasPrice: gasPrice
          };

          const signedTx = await web3.eth.accounts.signTransaction(tx, decrypted.privateKey);
          receipt = await web3.eth.sendSignedTransaction(signedTx.rawTransaction);
        }

        logToBackend('TRANSACTION_SENT', {
          hash: receipt.transactionHash,
          from: fromAddress,
          to: toAddress,
          value: amount,
          gasUsed: receipt.gasUsed,
          gasPrice: web3.utils.fromWei(gasPrice, 'gwei'),
          blockNumber: receipt.blockNumber,
          timestamp: new Date().toISOString()
        });

        return {
          ...receipt,
          gasFee: web3.utils.fromWei(gasFeeWei.toString(), 'ether'),
          gasPrice: web3.utils.fromWei(gasPrice, 'gwei')
        };
      } catch (err) {
        throw new Error('L·ªói g·ª≠i giao d·ªãch: ' + err.message);
      }
    }

    // === UI RENDERING ===
    function render() {
      const app = document.getElementById('app');
      
      if (currentPage === 'login') {
        app.innerHTML = renderLoginPage();
      } else if (currentPage === 'dashboard') {
        app.innerHTML = renderDashboard();
      }
    }

    function renderLoginPage() {
      const mode = localStorage.getItem('authMode') || 'login';
      
      return `
        <div class="card" style="max-width: 500px; margin: 50px auto;">
          <h1 style="text-align: center;">üîê V√≠ Blockchain</h1>
          <p style="text-align: center; color: #6B7280; margin-bottom: 25px;">
            ${mode === 'login' ? 'ƒêƒÉng nh·∫≠p t√†i kho·∫£n' : 'T·∫°o t√†i kho·∫£n m·ªõi'}
          </p>

          <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button class="tab ${mode === 'login' ? 'active' : ''}" onclick="switchAuthMode('login')">
              üîì ƒêƒÉng nh·∫≠p
            </button>
            <button class="tab ${mode === 'register' ? 'active' : ''}" onclick="switchAuthMode('register')">
              üìù ƒêƒÉng k√Ω
            </button>
          </div>

          ${mode === 'register' ? `
            <div>
              <input type="password" id="password" placeholder="M·∫≠t kh·∫©u (‚â• 6 k√Ω t·ª±)" />
              <input type="password" id="confirmPassword" placeholder="X√°c nh·∫≠n m·∫≠t kh·∫©u" />
              <button onclick="handleRegister()">‚ú® T·∫°o t√†i kho·∫£n</button>
              <div style="text-align: center; margin: 10px 0; color: #6B7280;">ho·∫∑c</div>
              <div class="grid-2">
                <button class="success" onclick="handleImportDevAccount()">üî• Import Dev Account</button>
                <button class="success" onclick="handleTestAccount()">üéÅ T·∫°o Test Account</button>
              </div>
            </div>
          ` : `
            <div>
              <input type="text" id="loginAddress" placeholder="ƒê·ªãa ch·ªâ v√≠ (0x...)" />
              <input type="password" id="loginPassword" placeholder="M·∫≠t kh·∫©u" />
              <button onclick="handleLogin()">üöÄ ƒêƒÉng nh·∫≠p</button>
            </div>
          `}

          <div id="authMessage"></div>
        </div>
      `;
    }

    function renderDashboard() {
      const activeTab = localStorage.getItem('dashboardTab') || 'balance';
      
      return `
        <div class="card">
          <div class="header">
            <div>
              <h1>üíº V√≠ c·ªßa b·∫°n</h1>
              <div class="address" style="display: flex; align-items: center;">
                <span>${currentAccount}</span>
                <button class="copy-btn" onclick="copyToClipboard('${currentAccount}', this)" title="Copy address">
                  üìã
                </button>
              </div>
            </div>
            <div style="text-align: right;">
              <div class="balance-display" id="currentBalance">0 ETH</div>
              <button class="danger" onclick="handleLogout()" style="width: auto; margin-top: 10px;">
                üö™ ƒêƒÉng xu·∫•t
              </button>
            </div>
          </div>
        </div>

        <div class="tabs">
          <button class="tab ${activeTab === 'balance' ? 'active' : ''}" onclick="switchTab('balance')">
            üí∞ S·ªë d∆∞
          </button>
          <button class="tab ${activeTab === 'chart' ? 'active' : ''}" onclick="switchTab('chart')">
            üìà Bi·ªÉu ƒë·ªì
          </button>
          <button class="tab ${activeTab === 'transfer' ? 'active' : ''}" onclick="switchTab('transfer')">
            üí∏ Chuy·ªÉn ti·ªÅn
          </button>
          <button class="tab ${activeTab === 'history' ? 'active' : ''}" onclick="switchTab('history')">
            üìú L·ªãch s·ª≠
          </button>
          <button class="tab ${activeTab === 'logs' ? 'active' : ''}" onclick="switchTab('logs')">
            üìä Logs
          </button>
        </div>

        <div class="card" id="tabContent"></div>
      `;
    }

    function renderBalanceTab() {
      return `
        <h2>üí∞ Ki·ªÉm tra s·ªë d∆∞</h2>
        <input type="text" id="checkAddress" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ v√≠" value="${currentAccount}" />
        <button onclick="checkBalance()">üîç Ki·ªÉm tra</button>
        <div id="balanceResult"></div>
      `;
    }

    function renderChartTab() {
      return `
        <h2>üìà Bi·ªÉu ƒë·ªì s·ªë d∆∞ theo th·ªùi gian</h2>
        <p style="color: #6B7280; font-size: 13px; margin-bottom: 15px;">
          Theo d√µi s·ª± thay ƒë·ªïi s·ªë d∆∞ c·ªßa v√≠ ${currentAccount.slice(0, 10)}...
        </p>
        <div class="chart-container">
          <canvas id="balanceChart"></canvas>
        </div>
        <div style="margin-top: 20px; text-align: center;">
          <button onclick="refreshChart()" style="width: auto; padding: 10px 20px;">
            üîÑ L√†m m·ªõi bi·ªÉu ƒë·ªì
          </button>
        </div>
      `;
    }

    function renderTransferTab() {
      const accounts = JSON.parse(localStorage.getItem('walletAccounts') || '[]');
      const currentAcc = accounts.find(a => a.address.toLowerCase() === currentAccount.toLowerCase());
      const isDevAccount = currentAcc && currentAcc.type === 'dev';
      
      return `
        <h2>üí∏ Chuy·ªÉn ti·ªÅn</h2>
        ${isDevAccount ? '<p style="color: #0D9488; font-size: 13px; margin-bottom: 10px;">üî• Dev Account - Kh√¥ng c·∫ßn m·∫≠t kh·∫©u</p>' : ''}
        <input type="text" value="${currentAccount}" disabled />
        <input type="text" id="transferTo" placeholder="ƒê·ªãa ch·ªâ nh·∫≠n (0x...)" oninput="calculateGasFee()" />
        <input type="number" id="transferAmount" placeholder="S·ªë ETH" step="0.001" oninput="calculateGasFee()" />
        
        <div id="gasFeeDisplay"></div>
        
        ${isDevAccount ? '' : '<input type="password" id="transferPassword" placeholder="M·∫≠t kh·∫©u v√≠" />'}
        <button onclick="handleTransfer()">üöÄ G·ª≠i giao d·ªãch</button>
        <div id="transferMessage"></div>
      `;
    }

    function renderHistoryTab() {
      const history = JSON.parse(localStorage.getItem('txHistory') || '[]');
      
      return `
        <h2>üìú L·ªãch s·ª≠ giao d·ªãch</h2>
        <p style="color: #6B7280; font-size: 13px; margin-bottom: 15px;">üí° Click v√†o b·∫•t k·ª≥ giao d·ªãch n√†o ƒë·ªÉ xem chi ti·∫øt</p>
        
        <div class="search-box">
          <input type="text" id="searchTx" placeholder="T√¨m ki·∫øm theo hash ho·∫∑c address..." />
          <button onclick="searchTransaction()">üîç T√¨m</button>
        </div>
        
        ${history.length === 0 ? 
          '<p style="text-align: center; color: #6B7280; padding: 40px;">Ch∆∞a c√≥ giao d·ªãch n√†o</p>' :
          `<div style="overflow-x: auto;">
            <table>
              <thead>
                <tr>
                  <th>Th·ªùi gian</th>
                  <th>T·ª´</th>
                  <th>ƒê·∫øn</th>
                  <th style="text-align: right;">S·ªë ti·ªÅn</th>
                  <th style="text-align: center;">Tr·∫°ng th√°i</th>
                </tr>
              </thead>
              <tbody id="historyTableBody">
                ${renderHistoryRows(history)}
              </tbody>
            </table>
          </div>`
        }
      `;
    }

    function renderHistoryRows(history) {
      return history.map(tx => `
        <tr onclick='showTransactionDetail(${JSON.stringify(tx).replaceAll(/'/g, "&apos;")})' style="cursor: pointer;">
          <td>${new Date(tx.timestamp).toLocaleString('vi-VN')}</td>
          <td class="address">${tx.from.slice(0, 10)}...</td>
          <td class="address">${tx.to.slice(0, 10)}...</td>
          <td style="text-align: right; font-weight: bold;">${tx.value} ETH</td>
          <td style="text-align: center;">
            <span class="status-badge ${tx.status === 'success' ? 'status-success' : 'status-failed'}">
              ${tx.status === 'success' ? '‚úì' : '‚úó'}
            </span>
          </td>
        </tr>
      `).join('');
    }

    function renderLogsTab() {
      const logs = JSON.parse(localStorage.getItem('gethLogs') || '[]');
      
      if (logs.length === 0) {
        return '<h2>üìä Backend Logs</h2><p style="text-align: center; color: #6B7280; padding: 40px;">Ch∆∞a c√≥ log n√†o</p>';
      }

      return `
        <h2>üìä Backend Logs</h2>
        <div style="max-height: 500px; overflow-y: auto;">
          ${logs.map(log => `
            <div class="log-entry">
              <div class="log-header">
                <span style="color: #6366F1;">${log.event}</span>
                <span style="font-size: 12px; color: #6B7280;">${new Date(log.timestamp).toLocaleString('vi-VN')}</span>
              </div>
              <div class="log-data">${JSON.stringify(log.data, null, 2)}</div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // === MODAL FUNCTIONS ===
    function showTransactionDetail(tx) {
      const modal = document.getElementById('txDetailModal');
      const modalBody = document.getElementById('modalBody');
      
      modalBody.innerHTML = `
        <div class="detail-row">
          <span class="detail-label">üîó Transaction Hash:</span>
          <span class="detail-value" style="display: flex; align-items: center; justify-content: flex-end;">
            <span style="word-break: break-all; margin-right: 8px;">${tx.hash ? tx.hash : 'N/A'}</span>
            ${tx.hash ? `<button class="copy-btn" onclick="event.stopPropagation(); copyToClipboard('${tx.hash}', this)" title="Copy hash">üìã</button>` : ''}
          </span>
        </div>
        <div class="detail-row">
          <span class="detail-label">üì§ T·ª´:</span>
          <span class="detail-value" style="word-break: break-all;">${tx.from}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">üì• ƒê·∫øn:</span>
          <span class="detail-value" style="word-break: break-all;">${tx.to}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">üí∞ S·ªë ti·ªÅn:</span>
          <span class="detail-value" style="color: #4B5EAA; font-weight: bold;">${tx.value} ETH</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">‚õΩ Gas Fee:</span>
          <span class="detail-value">${tx.gasFee || 'N/A'} ETH</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">‚ö° Gas Price:</span>
          <span class="detail-value">${tx.gasPrice || 'N/A'} Gwei</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">üì¶ Block Number:</span>
          <span class="detail-value">${tx.blockNumber || 'N/A'}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">üïí Th·ªùi gian:</span>
          <span class="detail-value">${new Date(tx.timestamp).toLocaleString('vi-VN')}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">‚úÖ Tr·∫°ng th√°i:</span>
          <span class="detail-value">
            <span class="status-badge ${tx.status === 'success' ? 'status-success' : 'status-failed'}">
              ${tx.status === 'success' ? '‚úì Th√†nh c√¥ng' : '‚úó Th·∫•t b·∫°i'}
            </span>
          </span>
        </div>
      `;
      
      modal.classList.add('show');
    }

    function closeModal() {
      const modal = document.getElementById('txDetailModal');
      modal.classList.remove('show');
    }

    // Copy to clipboard
    function copyToClipboard(text, button) {
      navigator.clipboard.writeText(text).then(() => {
        const originalText = button.innerHTML;
        button.innerHTML = '‚úì';
        button.classList.add('copied');
        
        setTimeout(() => {
          button.innerHTML = originalText;
          button.classList.remove('copied');
        }, 2000);
      }).catch(err => {
        console.error('Copy failed:', err);
        alert('Kh√¥ng th·ªÉ copy: ' + err.message);
      });
    }

    // ƒê√≥ng modal khi click b√™n ngo√†i
    globalThis.onclick = function(event) {
      const modal = document.getElementById('txDetailModal');
      if (event.target === modal) {
        closeModal();
      }
    }

    // === EVENT HANDLERS ===
    function switchAuthMode(mode) {
      localStorage.setItem('authMode', mode);
      render();
    }

    function switchTab(tab) {
      localStorage.setItem('dashboardTab', tab);
      const content = document.getElementById('tabContent');
      
      if (tab === 'balance') content.innerHTML = renderBalanceTab();
      else if (tab === 'chart') {
        content.innerHTML = renderChartTab();
        setTimeout(() => renderBalanceChart(), 100);
      }
      else if (tab === 'transfer') content.innerHTML = renderTransferTab();
      else if (tab === 'history') content.innerHTML = renderHistoryTab();
      else if (tab === 'logs') content.innerHTML = renderLogsTab();
    }

    // Render bi·ªÉu ƒë·ªì s·ªë d∆∞
    let balanceChartInstance = null;
    
    function renderBalanceChart() {
      const canvas = document.getElementById('balanceChart');
      if (!canvas) return;
      
      const history = getBalanceHistory(currentAccount);
      
      if (history.length === 0) {
        canvas.parentElement.innerHTML = '<p style="text-align: center; color: #6B7280; padding: 40px;">Ch∆∞a c√≥ d·ªØ li·ªáu s·ªë d∆∞. D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c thu th·∫≠p theo th·ªùi gian.</p>';
        return;
      }

      // Destroy old chart
      if (balanceChartInstance) {
        balanceChartInstance.destroy();
      }

      const ctx = canvas.getContext('2d');
      
      const labels = history.map(item => {
        const date = new Date(item.timestamp);
        return date.toLocaleString('vi-VN', { 
          month: 'short', 
          day: 'numeric', 
          hour: '2-digit', 
          minute: '2-digit' 
        });
      });
      
      const data = history.map(item => item.balance);

      balanceChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'S·ªë d∆∞ (ETH)',
            data: data,
            borderColor: '#4B5EAA',
            backgroundColor: 'rgba(75, 94, 170, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointRadius: 4,
            pointHoverRadius: 6,
            pointBackgroundColor: '#4B5EAA',
            pointBorderColor: '#FFFFFF',
            pointBorderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                font: { size: 14, weight: 'bold' },
                color: '#1F2937'
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#FFFFFF',
              bodyColor: '#FFFFFF',
              padding: 12,
              cornerRadius: 8,
              displayColors: false,
              callbacks: {
                label: function(context) {
                  return 'S·ªë d∆∞: ' + context.parsed.y.toFixed(6) + ' ETH';
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: false,
              ticks: {
                callback: function(value) {
                  return value.toFixed(4) + ' ETH';
                },
                color: '#6B7280',
                font: { size: 12 }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              }
            },
            x: {
              ticks: {
                maxRotation: 45,
                minRotation: 45,
                color: '#6B7280',
                font: { size: 11 }
              },
              grid: {
                display: false
              }
            }
          }
        }
      });
    }

    function refreshChart() {
      renderBalanceChart();
    }

    // T√≠nh to√°n gas fee khi nh·∫≠p
    async function calculateGasFee() {
      const to = document.getElementById('transferTo').value;
      const amount = document.getElementById('transferAmount').value;
      const displayEl = document.getElementById('gasFeeDisplay');

      if (!to || !amount || amount <= 0) {
        displayEl.innerHTML = '';
        return;
      }

      try {
        const gasInfo = await estimateGasFee(currentAccount, to, amount);
        displayEl.innerHTML = `
          <div class="gas-fee-box">
            <div style="font-weight: bold; margin-bottom: 10px; color: #1F2937;">‚õΩ Chi ph√≠ giao d·ªãch</div>
            <div class="gas-fee-row">
              <span>Gas Price:</span>
              <span>${Number.parseFloat(gasInfo.gasPrice).toFixed(2)} Gwei</span>
            </div>
            <div class="gas-fee-row">
              <span>Gas Limit:</span>
              <span>${gasInfo.gasLimit}</span>
            </div>
            <div class="gas-fee-row">
              <span>Gas Fee:</span>
              <span>${Number.parseFloat(gasInfo.gasFee).toFixed(6)} ETH</span>
            </div>
            <div class="gas-fee-row total">
              <span>T·ªïng c·ªông:</span>
              <span>${gasInfo.total} ETH</span>
            </div>
          </div>
        `;
      } catch (err) {
        displayEl.innerHTML = `<div class="message error">‚ùå ${err.message}</div>`;
      }
    }

    // T√¨m ki·∫øm giao d·ªãch
    function searchTransaction() {
      const searchTerm = document.getElementById('searchTx').value.toLowerCase().trim();
      const history = JSON.parse(localStorage.getItem('txHistory') || '[]');
      
      if (!searchTerm) {
        document.getElementById('historyTableBody').innerHTML = renderHistoryRows(history);
        return;
      }

      const filtered = history.filter(tx => 
        tx.hash.toLowerCase().includes(searchTerm) ||
        tx.from.toLowerCase().includes(searchTerm) ||
        tx.to.toLowerCase().includes(searchTerm)
      );

      const tbody = document.getElementById('historyTableBody');
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px; color: #6B7280;">Kh√¥ng t√¨m th·∫•y giao d·ªãch n√†o</td></tr>';
      } else {
        tbody.innerHTML = renderHistoryRows(filtered);
      }
    }

    async function handleRegister() {
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const messageEl = document.getElementById('authMessage');

      if (password.length < 6) {
        messageEl.innerHTML = '<div class="message error">‚ùå M·∫≠t kh·∫©u ph·∫£i ‚â• 6 k√Ω t·ª±</div>';
        return;
      }
      if (password !== confirmPassword) {
        messageEl.innerHTML = '<div class="message error">‚ùå M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp</div>';
        return;
      }

      messageEl.innerHTML = '<div class="message info">‚è≥ ƒêang t·∫°o t√†i kho·∫£n...</div>';

      try {
        const { address, encrypted } = await createAccount(password);
        
        const accounts = JSON.parse(localStorage.getItem('walletAccounts') || '[]');
        accounts.push({
          address,
          encrypted,
          createdAt: new Date().toISOString(),
          type: 'user'
        });
        localStorage.setItem('walletAccounts', JSON.stringify(accounts));

        messageEl.innerHTML = `<div class="message success">‚úÖ T·∫°o t√†i kho·∫£n th√†nh c√¥ng!<br><small>${address}</small></div>`;
        
        setTimeout(() => {
          currentAccount = address;
          localStorage.setItem('currentAccount', address);
          currentPage = 'dashboard';
          render();
          loadBalance();
        }, 1500);
      } catch (err) {
        messageEl.innerHTML = `<div class="message error">‚ùå L·ªói: ${err.message}</div>`;
      }
    }

    async function handleImportDevAccount() {
      const messageEl = document.getElementById('authMessage');
      messageEl.innerHTML = '<div class="message info">‚è≥ ƒêang import dev account...</div>';

      try {
        const { address, balance } = await importDevAccount();
        
        // Ki·ªÉm tra xem ƒë√£ import ch∆∞a
        const accounts = JSON.parse(localStorage.getItem('walletAccounts') || '[]');
        const existing = accounts.find(a => a.address.toLowerCase() === address.toLowerCase());
        
        if (existing) {
          messageEl.innerHTML = `<div class="message info">‚ÑπÔ∏è Dev account ƒë√£ t·ªìn t·∫°i!<br>üìç ${address}<br>üí∞ S·ªë d∆∞: ${balance} ETH</div>`;
          
          setTimeout(() => {
            currentAccount = address;
            localStorage.setItem('currentAccount', address);
            currentPage = 'dashboard';
            render();
            loadBalance();
          }, 2000);
          return;
        }
        
        accounts.push({
          address,
          type: 'dev',
          createdAt: new Date().toISOString()
        });
        localStorage.setItem('walletAccounts', JSON.stringify(accounts));

        messageEl.innerHTML = `<div class="message success">‚úÖ Import th√†nh c√¥ng!<br>üìç ${address}<br>üí∞ S·ªë d∆∞: ${balance} ETH<br>üîë Kh√¥ng c·∫ßn m·∫≠t kh·∫©u (qu·∫£n l√Ω b·ªüi Geth)</div>`;
        
        setTimeout(() => {
          currentAccount = address;
          localStorage.setItem('currentAccount', address);
          currentPage = 'dashboard';
          render();
          loadBalance();
        }, 2000);
      } catch (err) {
        messageEl.innerHTML = `<div class="message error">‚ùå L·ªói: ${err.message}</div>`;
      }
    }

    async function handleTestAccount() {
      const messageEl = document.getElementById('authMessage');
      messageEl.innerHTML = '<div class="message info">‚è≥ ƒêang t·∫°o test account...</div>';

      try {
        const { address, encrypted } = await createTestAccount();
        
        const accounts = JSON.parse(localStorage.getItem('walletAccounts') || '[]');
        accounts.push({
          address,
          encrypted,
          createdAt: new Date().toISOString(),
          type: 'test'
        });
        localStorage.setItem('walletAccounts', JSON.stringify(accounts));

        messageEl.innerHTML = `<div class="message success">‚úÖ Test account: ${address}<br>üí∞ S·ªë d∆∞: 100 ETH<br>üîë M·∫≠t kh·∫©u: 123456</div>`;
        
        setTimeout(() => {
          currentAccount = address;
          localStorage.setItem('currentAccount', address);
          currentPage = 'dashboard';
          render();
          loadBalance();
        }, 2000);
      } catch (err) {
        messageEl.innerHTML = `<div class="message error">‚ùå L·ªói: ${err.message}</div>`;
      }
    }

    async function handleLogin() {
      const address = document.getElementById('loginAddress').value;
      const password = document.getElementById('loginPassword').value;
      const messageEl = document.getElementById('authMessage');

      if (!address || !password) {
        messageEl.innerHTML = '<div class="message error">‚ùå Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin</div>';
        return;
      }

      messageEl.innerHTML = '<div class="message info">‚è≥ ƒêang ƒëƒÉng nh·∫≠p...</div>';

      try {
        const accounts = JSON.parse(localStorage.getItem('walletAccounts') || '[]');
        const account = accounts.find(a => a.address.toLowerCase() === address.toLowerCase());
        
        if (!account) {
          messageEl.innerHTML = '<div class="message error">‚ùå T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i</div>';
          return;
        }

        // Verify password
        web3.eth.accounts.decrypt(JSON.parse(account.encrypted), password);
        
        logToBackend('LOGIN_SUCCESS', { address });
        messageEl.innerHTML = '<div class="message success">‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng!</div>';
        
        setTimeout(() => {
          currentAccount = address;
          localStorage.setItem('currentAccount', address);
          currentPage = 'dashboard';
          render();
          loadBalance();
        }, 1000);
      } catch (err) {
        messageEl.innerHTML = '<div class="message error">‚ùå Sai m·∫≠t kh·∫©u!</div>';
      }
    }

    function handleLogout() {
      if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t?')) {
        currentAccount = null;
        localStorage.removeItem('currentAccount');
        currentPage = 'login';
        render();
      }
    }

    async function loadBalance() {
      if (!currentAccount) return;
      
      try {
        const balance = await getBalance(currentAccount);
        const balanceEl = document.getElementById('currentBalance');
        if (balanceEl) {
          balanceEl.textContent = Number.parseFloat(balance).toFixed(4) + ' ETH';
        }
        
        // L∆∞u l·ªãch s·ª≠ s·ªë d∆∞
        saveBalanceHistory(currentAccount, balance);
      } catch (err) {
        console.error('L·ªói load balance:', err);
      }
    }

    async function checkBalance() {
      const address = document.getElementById('checkAddress').value;
      const resultEl = document.getElementById('balanceResult');

      if (!address) {
        resultEl.innerHTML = '<div class="message error">‚ùå Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ</div>';
        return;
      }

      resultEl.innerHTML = '<div class="message info">‚è≥ ƒêang ki·ªÉm tra...</div>';

      try {
        const balance = await getBalance(address);
        resultEl.innerHTML = `<div class="message success">üí∞ S·ªë d∆∞: <strong>${Number.parseFloat(balance).toFixed(6)} ETH</strong></div>`;
      } catch (err) {
        resultEl.innerHTML = `<div class="message error">‚ùå L·ªói: ${err.message}</div>`;
      }
    }

    async function handleTransfer() {
      const to = document.getElementById('transferTo').value;
      const amount = document.getElementById('transferAmount').value;
      const passwordInput = document.getElementById('transferPassword');
      const password = passwordInput ? passwordInput.value : '';
      const messageEl = document.getElementById('transferMessage');

      const accounts = JSON.parse(localStorage.getItem('walletAccounts') || '[]');
      const currentAcc = accounts.find(a => a.address.toLowerCase() === currentAccount.toLowerCase());
      const isDevAccount = currentAcc && currentAcc.type === 'dev';

      if (!to || !amount) {
        messageEl.innerHTML = '<div class="message error">‚ùå Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin</div>';
        return;
      }

      if (!isDevAccount && !password) {
        messageEl.innerHTML = '<div class="message error">‚ùå Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u</div>';
        return;
      }

      messageEl.innerHTML = '<div class="message info">‚è≥ ƒêang g·ª≠i giao d·ªãch...</div>';

      try {
        const receipt = await sendTransaction(currentAccount, to, amount, password);
        
        // L∆∞u v√†o history
        const history = JSON.parse(localStorage.getItem('txHistory') || '[]');
        history.unshift({
          hash: receipt.transactionHash,
          from: currentAccount,
          to,
          value: amount,
          blockNumber: receipt.blockNumber,
          gasFee: receipt.gasFee,
          gasPrice: receipt.gasPrice,
          status: receipt.status ? 'success' : 'failed',
          timestamp: new Date().toISOString()
        });
        localStorage.setItem('txHistory', JSON.stringify(history));

        messageEl.innerHTML = `
          <div class="message success">
            ‚úÖ Th√†nh c√¥ng!<br>
            <small>Hash: ${receipt.transactionHash}</small><br>
            <button onclick='showTransactionDetail(${JSON.stringify(history[0]).replaceAll(/'/g, "&apos;")})' 
                    style="margin-top: 10px; width: auto; padding: 8px 16px;">
              üîç Xem chi ti·∫øt
            </button>
          </div>
        `;
        
        document.getElementById('transferTo').value = '';
        document.getElementById('transferAmount').value = '';
        if (passwordInput) passwordInput.value = '';
        document.getElementById('gasFeeDisplay').innerHTML = '';
        
        loadBalance();
      } catch (err) {
        messageEl.innerHTML = `<div class="message error">‚ùå L·ªói: ${err.message}</div>`;
      }
    }

    // === INITIALIZATION ===
    async function init() {
      const connected = await initWeb3();
      
      if (!connected) {
        document.getElementById('app').innerHTML = `
          <div class="card" style="max-width: 600px; margin: 50px auto; text-align: center;">
            <h1 style="color: #DC2626;">‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi Geth</h1>
            <p style="margin: 20px 0;">Vui l√≤ng ki·ªÉm tra:</p>
            <ul style="text-align: left; padding-left: 40px;">
              <li>Geth ƒë√£ ch·∫°y: <code>geth --dev --http --http.api eth,net,web3 --http.corsdomain "*"</code></li>
              <li>RPC ƒëang l·∫Øng nghe t·∫°i: <code>http://127.0.0.1:8545</code></li>
              <li>CORS ƒë∆∞·ª£c b·∫≠t</li>
            </ul>
            <button onclick="location.reload()">üîÑ Th·ª≠ l·∫°i</button>
          </div>
        `;
        return;
      }

      const savedAccount = localStorage.getItem('currentAccount');
      if (savedAccount) {
        currentAccount = savedAccount;
        currentPage = 'dashboard';
      }

      render();
      
      if (currentPage === 'dashboard') {
        loadBalance();
        switchTab(localStorage.getItem('dashboardTab') || 'balance');
        setInterval(loadBalance, 10000);
      }
    }

    // Start app
    init();
  </script>
</body>
</html>