<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Geth Wallet Manager - Secure</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    :root {
      --bg-primary: linear-gradient(135deg, #4B5EAA 0%, #6B7280 100%);
      --bg-card: #FFFFFF;
      --bg-input: #FFFFFF;
      --text-primary: #1F2937;
      --text-secondary: #6B7280;
      --border-color: #D1D5DB;
      --button-primary: linear-gradient(135deg, #4B5EAA 0%, #6366F1 100%);
      --button-secondary: #E5E7EB;
      --success-bg: #D1FAE5;
      --success-text: #065F46;
      --success-border: #0D9488;
      --error-bg: #FEE2E2;
      --error-text: #991B1B;
      --error-border: #DC2626;
      --warning-bg: #FEF3C7;
      --warning-text: #92400E;
      --warning-border: #F59E0B;
      --table-header: #F3F4F6;
      --table-border: #E5E7EB;
      --table-hover: #F9FAFB;
      --shadow: rgba(0,0,0,0.1);
    }

    [data-theme="dark"] {
      --bg-primary: linear-gradient(135deg, #1F2937 0%, #111827 100%);
      --bg-card: #1F2937;
      --bg-input: #374151;
      --text-primary: #F9FAFB;
      --text-secondary: #D1D5DB;
      --border-color: #4B5563;
      --button-primary: linear-gradient(135deg, #6366F1 0%, #4F46E5 100%);
      --button-secondary: #374151;
      --success-bg: #064E3B;
      --success-text: #D1FAE5;
      --success-border: #0D9488;
      --error-bg: #7F1D1D;
      --error-text: #FEE2E2;
      --error-border: #DC2626;
      --warning-bg: #78350F;
      --warning-text: #FEF3C7;
      --warning-border: #F59E0B;
      --table-header: #374151;
      --table-border: #4B5563;
      --table-hover: #2D3748;
      --shadow: rgba(0,0,0,0.3);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      min-height: 100vh;
      padding: 20px;
      color: var(--text-primary);
      transition: background 0.3s, color 0.3s;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    .card { 
      background: var(--bg-card); 
      border-radius: 16px; 
      padding: 30px; 
      margin-bottom: 20px;
      box-shadow: 0 10px 30px var(--shadow);
      transition: background 0.3s;
    }
    input, button, select { 
      width: 100%; 
      padding: 12px 16px; 
      border-radius: 8px; 
      border: 2px solid var(--border-color);
      font-size: 14px;
      margin-bottom: 12px;
      transition: all 0.3s;
      background: var(--bg-input);
      color: var(--text-primary);
    }
    input:focus { border-color: #6366F1; outline: none; }
    button { 
      background: var(--button-primary);
      color: #FFFFFF; 
      border: none; 
      cursor: pointer;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(75,94,170,0.3); }
    button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    button.secondary { background: var(--button-secondary); color: var(--text-primary); }
    button.danger { background: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%); }
    button.success { background: linear-gradient(135deg, #0D9488 0%, #047857 100%); }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .tab { 
      flex: 1; 
      min-width: 120px;
      padding: 14px 20px; 
      background: var(--button-secondary); 
      border: none; 
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      color: var(--text-primary);
      transition: all 0.3s;
    }
    .tab.active { 
      background: var(--button-primary);
      color: #FFFFFF;
      box-shadow: 0 5px 15px rgba(75,94,170,0.3);
    }
    .message { 
      padding: 15px; 
      border-radius: 10px; 
      margin-top: 15px;
      animation: slideIn 0.3s;
    }
    @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .message.success { background: var(--success-bg); color: var(--success-text); border-left: 4px solid var(--success-border); }
    .message.error { background: var(--error-bg); color: var(--error-text); border-left: 4px solid var(--error-border); }
    .message.info { background: var(--warning-bg); color: var(--warning-text); border-left: 4px solid var(--warning-border); }
    .message.warning { background: #FEF3C7; color: #92400E; border-left: 4px solid #F59E0B; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th { background: var(--table-header); padding: 12px; text-align: left; font-weight: 600; color: var(--text-primary); }
    td { padding: 12px; border-bottom: 1px solid var(--table-border); font-size: 14px; color: var(--text-secondary); }
    tr:hover { background: var(--table-hover); }
    .header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 10px;
      flex-wrap: wrap;
      gap: 15px;
    }
    .balance-display { 
      font-size: 24px; 
      font-weight: 600; 
      color: #4B5EAA;
      text-shadow: 1px 1px 2px var(--shadow);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    [data-theme="dark"] .balance-display {
      color: #6366F1;
    }
    .balance-toggle {
      background: var(--button-secondary);
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      padding: 0;
      margin: 0;
      color: var(--text-primary);
    }
    .balance-toggle:hover {
      background: var(--border-color);
      transform: scale(1.05);
    }
    .balance-hidden {
      letter-spacing: 3px;
      font-size: 20px;
    }
    .address { 
      font-family: 'Courier New', monospace; 
      font-size: 13px; 
      color: var(--text-secondary);
      word-break: break-all;
    }
    .address-clickable {
      cursor: pointer;
      transition: all 0.3s;
      padding: 8px 12px;
      border-radius: 8px;
      display: inline-block;
    }
    .address-clickable:hover {
      background: var(--table-header);
      transform: translateX(5px);
    }
    .log-entry { 
      background: var(--table-header); 
      padding: 12px; 
      margin-bottom: 8px; 
      border-radius: 8px;
      border-left: 4px solid #6366F1;
    }
    .log-header { 
      display: flex; 
      justify-content: space-between; 
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-primary);
    }
    .log-data { 
      font-size: 12px; 
      color: var(--text-secondary); 
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: bold;
    }
    .status-success { background: #0D9488; color: #FFFFFF; }
    .status-failed { background: #DC2626; color: #FFFFFF; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      animation: fadeIn 0.3s;
    }
    .modal.show { display: flex; align-items: center; justify-content: center; }
    #txDetailModal { z-index: 1001; }
    .modal-content {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      animation: slideUp 0.3s;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--border-color);
    }
    .modal-close {
      background: var(--button-secondary);
      border: none;
      width: 35px;
      height: 35px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      line-height: 1;
      margin: 0;
      color: var(--text-primary);
    }
    .modal-close:hover { background: var(--border-color); transform: none; }
    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--table-border);
    }
    .detail-label { color: var(--text-secondary); font-weight: 600; }
    .detail-value { color: var(--text-primary); font-weight: 500; text-align: right; word-break: break-all; }
    .search-box {
      position: relative;
      margin-bottom: 15px;
    }
    .search-box input {
      padding-right: 100px;
    }
    .search-box button {
      position: absolute;
      right: 5px;
      top: 5px;
      width: auto;
      padding: 8px 15px;
      margin: 0;
    }
    .gas-fee-box {
      background: var(--table-header);
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }
    .gas-fee-row {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      font-size: 14px;
    }
    .gas-fee-row.total {
      font-weight: bold;
      font-size: 16px;
      color: #4B5EAA;
      padding-top: 10px;
      margin-top: 10px;
      border-top: 2px solid var(--border-color);
    }
    [data-theme="dark"] .gas-fee-row.total {
      color: #6366F1;
    }
    .copy-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #6366F1;
      color: white;
      border: none;
      width: 28px;
      height: 28px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-left: 8px;
      transition: all 0.3s;
      padding: 0;
    }
    .copy-btn:hover {
      background: #4F46E5;
      transform: scale(1.1);
    }
    .copy-btn.copied {
      background: #0D9488;
    }
    .chart-container {
      position: relative;
      height: 300px;
      margin-top: 20px;
    }
    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--bg-card);
      border: 2px solid var(--border-color);
      cursor: pointer;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      z-index: 999;
      box-shadow: 0 4px 12px var(--shadow);
    }
    .theme-toggle:hover {
      transform: rotate(180deg) scale(1.1);
    }
    .security-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      margin-top: 10px;
    }
    .security-badge.verified {
      background: #D1FAE5;
      color: #065F46;
      border: 1px solid #0D9488;
    }
    .security-badge.warning {
      background: #FEF3C7;
      color: #92400E;
      border: 1px solid #F59E0B;
    }
    .security-badge.danger {
      background: #FEE2E2;
      color: #991B1B;
      border: 1px solid #DC2626;
    }
    [data-theme="dark"] .security-badge.verified {
      background: #064E3B;
      color: #D1FAE5;
    }
    [data-theme="dark"] .security-badge.warning {
      background: #78350F;
      color: #FEF3C7;
    }
    [data-theme="dark"] .security-badge.danger {
      background: #7F1D1D;
      color: #FEE2E2;
    }
    .phishing-warning {
      background: #FEF3C7;
      border: 2px solid #F59E0B;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      display: none;
    }
    [data-theme="dark"] .phishing-warning {
      background: #78350F;
      border-color: #F59E0B;
    }
    .phishing-warning.show {
      display: block;
      animation: shake 0.5s;
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }
    .address-validation {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: -10px;
      margin-bottom: 10px;
      font-size: 12px;
    }
    .validation-icon {
      font-size: 16px;
    }
    @media (max-width: 768px) {
      .grid-2 { grid-template-columns: 1fr; }
      .header { flex-direction: column; text-align: center; }
      .theme-toggle { top: 10px; right: 10px; width: 45px; height: 45px; }
    }
    h1, h2 { margin-bottom: 15px; color: var(--text-primary); }
    h1 { font-size: 28px; }
    h2 { font-size: 20px; }
    .loading { text-align: center; padding: 40px; color: var(--text-primary); font-size: 18px; }
  </style>
</head>
<body>
  <!-- Theme Toggle Button -->
  <button class="theme-toggle" onclick="toggleTheme()" title="Chuyển đổi chế độ sáng/tối">
    <span id="themeIcon">🌙</span>
  </button>

  <div id="app" class="container">
    <div class="loading">⏳ Đang khởi tạo ví...</div>
  </div>

  <!-- Modal chi tiết giao dịch -->
  <div id="txDetailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>📋 Chi tiết giao dịch</h2>
        <button class="modal-close" onclick="closeModal('txDetailModal')">✕</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <!-- Modal thông tin ví -->
  <div id="walletInfoModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h2>💼 Thông tin ví</h2>
        <button class="modal-close" onclick="closeModal('walletInfoModal')">✕</button>
      </div>
      <div id="walletInfoBody"></div>
    </div>
  </div>

  <script>
    const GETH_RPC = 'http://127.0.0.1:8545';
    let web3;
    let currentAccount = null;
    let currentPage = 'login';
    let balanceVisible = true;
    let currentBalanceValue = '0.000000';

    // ==================== THEME MANAGEMENT ====================
    
    function initTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      const root = document.documentElement;
      root.dataset.theme = savedTheme;
      updateThemeIcon(savedTheme);
    }

    function toggleTheme() {
      const root = document.documentElement;
      const currentTheme = root.dataset.theme || 'light';
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      root.dataset.theme = newTheme;
      localStorage.setItem('theme', newTheme);
      updateThemeIcon(newTheme);
      
      // Re-render chart if visible
      if (currentPage === 'dashboard' && localStorage.getItem('dashboardTab') === 'chart') {
        setTimeout(() => renderBalanceChart(), 100);
      }
    }

    function updateThemeIcon(theme) {
      const icon = document.getElementById('themeIcon');
      if (icon) {
        icon.textContent = theme === 'light' ? '🌙' : '☀️';
      }
    }

    // ==================== SECURITY FUNCTIONS ====================
    
    // Danh sách đen địa chỉ phishing (mẫu - có thể mở rộng)
    const BLACKLIST_ADDRESSES = new Set([
      '0x0000000000000000000000000000000000000000',
      '0xdead000000000000000000000000000000000000'
    ]);

    // Kiểm tra địa chỉ có hợp lệ không
    function validateAddress(address) {
      if (!address) {
        return { valid: false, message: '❌ Địa chỉ không được để trống' };
      }

      // Kiểm tra format cơ bản
      if (!/^0x[a-fA-F0-9]{40}$/.test(address)) {
        return { valid: false, message: '❌ Địa chỉ không đúng định dạng (0x + 40 ký tự hex)' };
      }

      // Kiểm tra blacklist
      if (BLACKLIST_ADDRESSES.has(address.toLowerCase())) {
        return { valid: false, message: '⚠️ CẢNH BÁO: Địa chỉ này nằm trong danh sách đen!' };
      }

      // Kiểm tra checksum
      try {
        const checksumAddress = web3.utils.toChecksumAddress(address);
        
        // Nếu địa chỉ có chữ hoa/thường hỗn hợp nhưng không khớp checksum
        if (address !== address.toLowerCase() && address !== address.toUpperCase()) {
          if (address !== checksumAddress) {
            return { 
              valid: false, 
              message: '⚠️ Checksum không hợp lệ! Địa chỉ có thể đã bị sửa đổi.',
              corrected: checksumAddress
            };
          }
        }

        return { valid: true, message: '✅ Địa chỉ hợp lệ', checksumAddress };
      } catch (err) {
        return { valid: false, message: '❌ Địa chỉ không hợp lệ: ' + err.message };
      }
    }

    // Kiểm tra phishing dựa trên pattern
    function checkPhishingPattern(address) {
      const warnings = [];

      // Kiểm tra địa chỉ null
      if (address.toLowerCase() === '0x0000000000000000000000000000000000000000') {
        warnings.push('🚨 Địa chỉ NULL - tiền sẽ bị mất vĩnh viễn!');
      }

      // Kiểm tra nhiều số 0 liên tiếp (có thể là typo)
      if (/0{8,}/.test(address)) {
        warnings.push('⚠️ Địa chỉ chứa nhiều số 0 liên tiếp - kiểm tra kỹ!');
      }

      // Kiểm tra pattern lặp lại đáng ngờ
      if (/(.)\1{10,}/.test(address)) {
        warnings.push('⚠️ Địa chỉ có ký tự lặp lại bất thường!');
      }

      return warnings;
    }

    // Hiển thị cảnh báo phishing
    function showPhishingWarning(warnings) {
      const warningDiv = document.getElementById('phishingWarning');
      if (!warningDiv) return;

      if (warnings.length > 0) {
        warningDiv.innerHTML = `
          <div style="display: flex; align-items: start; gap: 10px;">
            <div style="font-size: 24px;">⚠️</div>
            <div>
              <div style="font-weight: bold; margin-bottom: 5px;">CẢNH BÁO BẢO MẬT</div>
              ${warnings.map(w => `<div style="margin: 5px 0;">• ${w}</div>`).join('')}
            </div>
          </div>
        `;
        warningDiv.classList.add('show');
      } else {
        warningDiv.classList.remove('show');
      }
    }

    // ==================== STORAGE FUNCTIONS ====================
    
    function saveBalanceHistory(address, balance) {
      const historyKey = `balanceHistory_${address}`;
      let history = JSON.parse(localStorage.getItem(historyKey) || '[]');
      
      const now = new Date().toISOString();
      const lastEntry = history.at(-1);
      
      if (!lastEntry || 
          lastEntry.balance !== balance || 
          (new Date(now) - new Date(lastEntry.timestamp)) > 60000) {
        history.push({
          balance: Number.parseFloat(balance),
          timestamp: now
        });
        
        if (history.length > 100) {
          history = history.slice(-100);
        }
        
        localStorage.setItem(historyKey, JSON.stringify(history));
      }
    }

    function getBalanceHistory(address) {
      const historyKey = `balanceHistory_${address}`;
      return JSON.parse(localStorage.getItem(historyKey) || '[]');
    }

    function saveCurrentBalance(address, balance) {
      const balanceKey = `savedBalance_${address}`;
      localStorage.setItem(balanceKey, balance);
    }

    function getSavedBalance(address) {
      const balanceKey = `savedBalance_${address}`;
      return localStorage.getItem(balanceKey);
    }

    async function restoreBalanceIfNeeded(address) {
      try {
        const currentBalance = await getBalance(address);
        const savedBalance = getSavedBalance(address);
        
        if (savedBalance && Number.parseFloat(savedBalance) > 0 && Number.parseFloat(currentBalance) === 0) {
          console.log(`🔄 Phát hiện số dư bị reset. Đang khôi phục ${savedBalance} ETH...`);
          
          const accounts = await web3.eth.getAccounts();
          if (accounts && accounts.length > 0) {
            const devAddress = accounts[0];
            
            await web3.eth.sendTransaction({
              from: devAddress,
              to: address,
              value: web3.utils.toWei(savedBalance, 'ether'),
              gas: 21000
            });
            
            console.log(`✅ Đã khôi phục ${savedBalance} ETH cho ${address}`);
            
            logToBackend('BALANCE_RESTORED', {
              address: address,
              amount: savedBalance + ' ETH',
              timestamp: new Date().toISOString()
            });
            
            return true;
          }
        }
        
        return false;
      } catch (err) {
        console.error('Lỗi khôi phục số dư:', err);
        return false;
      }
    }

    // ==================== WEB3 FUNCTIONS ====================
    
    async function initWeb3() {
      try {
        web3 = new Web3(new Web3.providers.HttpProvider(GETH_RPC));
        const networkId = await web3.eth.net.getId();
        console.log('✅ Kết nối Geth thành công - Network ID:', networkId);
        return true;
      } catch (err) {
        console.error('❌ Không thể kết nối Geth:', err);
        return false;
      }
    }

    function logToBackend(event, data) {
      const logs = JSON.parse(localStorage.getItem('gethLogs') || '[]');
      logs.unshift({
        event,
        data,
        timestamp: new Date().toISOString()
      });
      localStorage.setItem('gethLogs', JSON.stringify(logs.slice(0, 100)));
      console.log(`[GETH LOG] ${event}:`, data);
    }

    async function createAccount(password) {
      try {
        const account = web3.eth.accounts.create();
        const encrypted = web3.eth.accounts.encrypt(account.privateKey, password);
        
        logToBackend('ACCOUNT_CREATED', {
          address: account.address,
          timestamp: new Date().toISOString()
        });

        return { address: account.address, encrypted: JSON.stringify(encrypted) };
      } catch (err) {
        throw new Error('Không thể tạo tài khoản: ' + err.message);
      }
    }

    async function importDevAccount() {
      try {
        const accounts = await web3.eth.getAccounts();
        if (!accounts || accounts.length === 0) {
          throw new Error('Không có account Geth! Chạy: geth --dev --http --http.api eth,net,web3,personal');
        }

        const devAddress = accounts[0];
        const balance = await web3.eth.getBalance(devAddress);
        
        logToBackend('DEV_ACCOUNT_IMPORTED', {
          address: devAddress,
          balance: web3.utils.fromWei(balance, 'ether') + ' ETH',
          timestamp: new Date().toISOString()
        });

        return {
          address: devAddress,
          balance: web3.utils.fromWei(balance, 'ether'),
          type: 'dev'
        };
      } catch (err) {
        throw new Error('Lỗi import dev account: ' + err.message);
      }
    }

    async function getBalance(address) {
      try {
        const balance = await web3.eth.getBalance(address);
        return web3.utils.fromWei(balance, 'ether');
      } catch (err) {
        throw new Error('Không thể lấy số dư: ' + err.message);
      }
    }

    async function estimateGasFee(fromAddress, toAddress, amount) {
      try {
        const gasPrice = await web3.eth.getGasPrice();
        const gasLimit = 21000;
        const gasFeeWei = BigInt(gasPrice) * BigInt(gasLimit);
        const gasFeeEth = web3.utils.fromWei(gasFeeWei.toString(), 'ether');
        
        return {
          gasPrice: web3.utils.fromWei(gasPrice, 'gwei'),
          gasLimit,
          gasFee: gasFeeEth,
          total: (Number.parseFloat(amount) + Number.parseFloat(gasFeeEth)).toFixed(6)
        };
      } catch (err) {
        throw new Error('Không thể tính gas fee: ' + err.message);
      }
    }

    async function sendTransaction(fromAddress, toAddress, amount, password) {
      try {
        const accounts = JSON.parse(localStorage.getItem('walletAccounts') || '[]');
        const account = accounts.find(a => a.address.toLowerCase() === fromAddress.toLowerCase());
        
        if (!account) throw new Error('Không tìm thấy tài khoản!');

        const valueWei = web3.utils.toWei(amount.toString(), 'ether');
        const balance = await web3.eth.getBalance(fromAddress);
        const gasPrice = await web3.eth.getGasPrice();
        const gasLimit = 21000;
        const gasFeeWei = BigInt(gasPrice) * BigInt(gasLimit);
        const totalWei = BigInt(valueWei) + gasFeeWei;
        
        if (BigInt(balance) < totalWei) {
          throw new Error(`Số dư không đủ (cần ${web3.utils.fromWei(totalWei.toString(), 'ether')} ETH, có ${web3.utils.fromWei(balance, 'ether')} ETH)`);
        }

        let receipt;

        if (account.type === 'dev') {
          const tx = {
            from: fromAddress,
            to: toAddress,
            value: valueWei,
            gas: gasLimit,
            gasPrice: gasPrice
          };

          receipt = await web3.eth.sendTransaction(tx);
        } else {
          let decrypted;
          try {
            decrypted = web3.eth.accounts.decrypt(JSON.parse(account.encrypted), password);
          } catch {
            throw new Error('Mật khẩu không đúng!');
          }

          const tx = {
            from: fromAddress,
            to: toAddress,
            value: valueWei,
            gas: gasLimit,
            gasPrice: gasPrice
          };

          const signedTx = await web3.eth.accounts.signTransaction(tx, decrypted.privateKey);
          receipt = await web3.eth.sendSignedTransaction(signedTx.rawTransaction);
        }

        logToBackend('TRANSACTION_SENT', {
          hash: receipt.transactionHash,
          from: fromAddress,
          to: toAddress,
          value: amount,
          gasUsed: receipt.gasUsed,
          gasPrice: web3.utils.fromWei(gasPrice, 'gwei'),
          blockNumber: receipt.blockNumber,
          timestamp: new Date().toISOString()
        });

        return {
          ...receipt,
          gasFee: web3.utils.fromWei(gasFeeWei.toString(), 'ether'),
          gasPrice: web3.utils.fromWei(gasPrice, 'gwei')
        };
      } catch (err) {
        throw new Error('Lỗi gửi giao dịch: ' + err.message);
      }
    }

    // ==================== UI RENDERING ====================
    
    function render() {
      const app = document.getElementById('app');
      
      if (currentPage === 'login') {
        app.innerHTML = renderLoginPage();
      } else if (currentPage === 'dashboard') {
        app.innerHTML = renderDashboard();
      }
    }

    function renderLoginPage() {
      const mode = localStorage.getItem('authMode') || 'login';
      
      return `
        <div class="card" style="max-width: 500px; margin: 50px auto;">
          <h1 style="text-align: center;">🔐 Ví Blockchain</h1>
          <p style="text-align: center; color: var(--text-secondary); margin-bottom: 25px;">
            ${mode === 'login' ? 'Đăng nhập tài khoản' : 'Tạo tài khoản mới'}
          </p>

          <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button class="tab ${mode === 'login' ? 'active' : ''}" onclick="switchAuthMode('login')">
              🔓 Đăng nhập
            </button>
            <button class="tab ${mode === 'register' ? 'active' : ''}" onclick="switchAuthMode('register')">
              📝 Đăng ký
            </button>
          </div>

          ${mode === 'register' ? `
            <div>
              <input type="password" id="password" placeholder="Mật khẩu (≥ 6 ký tự)" />
              <input type="password" id="confirmPassword" placeholder="Xác nhận mật khẩu" />
              <button onclick="handleRegister()">✨ Tạo tài khoản</button>
              <div style="text-align: center; margin: 10px 0; color: var(--text-secondary);">hoặc</div>
              <button class="success" onclick="handleImportDevAccount()">🔥 Import Dev Account</button>
            </div>
          ` : `
            <div>
              <input type="text" id="loginAddress" placeholder="Địa chỉ ví (0x...)" />
              <input type="password" id="loginPassword" placeholder="Mật khẩu" />
              <button onclick="handleLogin()">🚀 Đăng nhập</button>
            </div>
          `}

          <div id="authMessage"></div>
        </div>
      `;
    }

    function renderDashboard() {
      const activeTab = localStorage.getItem('dashboardTab') || 'chart';
      
      return `
        <div class="card">
          <div class="header">
            <div>
              <h1>💼 Ví của bạn</h1>
              <div class="address address-clickable" onclick="showWalletInfo()" title="Click để xem thông tin chi tiết">
                <span>${currentAccount}</span>
                <button class="copy-btn" onclick="event.stopPropagation(); copyToClipboard('${currentAccount}', this)" title="Copy address">
                  📋
                </button>
              </div>
            </div>
            <div style="text-align: right;">
              <div class="balance-display">
                <button class="balance-toggle" onclick="toggleBalanceVisibility()" title="Ẩn/Hiện số dư">
                  👁️
                </button>
                <span id="currentBalance">0.000000 ETH</span>
              </div>
              <button class="danger" onclick="handleLogout()" style="width: auto; margin-top: 10px;">
                🚪 Đăng xuất
              </button>
            </div>
          </div>
        </div>

        <div class="tabs">
          <button class="tab ${activeTab === 'chart' ? 'active' : ''}" onclick="switchTab('chart')">
            📈 Biểu đồ
          </button>
          <button class="tab ${activeTab === 'transfer' ? 'active' : ''}" onclick="switchTab('transfer')">
            💸 Chuyển tiền
          </button>
          <button class="tab ${activeTab === 'erc20' ? 'active' : ''}" onclick="switchTab('erc20')">
            🪙 ERC-20 Token
          </button>
          <button class="tab ${activeTab === 'contract' ? 'active' : ''}" onclick="switchTab('contract')">
            📄 Deploy Contract
          </button>
          <button class="tab ${activeTab === 'interact' ? 'active' : ''}" onclick="switchTab('interact')">
            🔧 Contract Interact
          </button>
          <button class="tab ${activeTab === 'logs' ? 'active' : ''}" onclick="switchTab('logs')">
            📊 Logs
          </button>
        </div>

        <div class="card" id="tabContent"></div>
      `;
    }

    function renderWalletInfo() {
      const history = JSON.parse(localStorage.getItem('txHistory') || '[]');
      const walletHistory = history.filter(tx => 
        tx.from.toLowerCase() === currentAccount.toLowerCase() || 
        tx.to.toLowerCase() === currentAccount.toLowerCase()
      );
      
      return `
        <div class="detail-row" style="border-bottom: 2px solid var(--border-color); padding-bottom: 20px; margin-bottom: 20px;">
          <span class="detail-label" style="font-size: 16px;">📍 Địa chỉ ví:</span>
          <span class="detail-value" style="word-break: break-all; font-family: 'Courier New', monospace;">
            ${currentAccount}
            <button class="copy-btn" onclick="event.stopPropagation(); copyToClipboard('${currentAccount}', this)" title="Copy address">
              📋
            </button>
          </span>
        </div>
        
        <div class="detail-row" style="border-bottom: 2px solid var(--border-color); padding-bottom: 20px; margin-bottom: 20px;">
          <span class="detail-label" style="font-size: 16px;">💰 Số dư hiện tại:</span>
          <span class="detail-value" style="font-size: 24px; font-weight: bold; color: #4B5EAA;">
            ${currentBalanceValue} ETH
          </span>
        </div>

        <h3 style="margin: 20px 0 15px 0; color: var(--text-primary);">📜 Lịch sử giao dịch</h3>
        
        <div class="search-box" style="margin-bottom: 15px;">
          <input type="text" id="walletSearchTx" placeholder="Tìm kiếm theo hash hoặc address..." />
          <button onclick="searchWalletTransaction()">🔍 Tìm</button>
        </div>

        ${walletHistory.length === 0 ? 
          '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">Chưa có giao dịch nào</p>' :
          `<div style="overflow-x: auto; max-height: 400px; overflow-y: auto;">
            <table>
              <thead>
                <tr>
                  <th>Thời gian</th>
                  <th>Từ</th>
                  <th>Đến</th>
                  <th style="text-align: right;">Số tiền</th>
                  <th style="text-align: center;">Trạng thái</th>
                </tr>
              </thead>
              <tbody id="walletHistoryTableBody">
                ${renderHistoryRows(walletHistory)}
              </tbody>
            </table>
          </div>`
        }
      `;
    }

    function renderChartTab() {
      return `
        <h2>📈 Biểu đồ số dư theo thời gian</h2>
        <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 15px;">
          Theo dõi sự thay đổi số dư của ví ${currentAccount.slice(0, 10)}...
        </p>
        <div id="chartLoadingMessage"></div>
        <div class="chart-container">
          <canvas id="balanceChart"></canvas>
        </div>
        <div style="margin-top: 20px; text-align: center;">
          <button onclick="refreshChart()" style="width: auto; padding: 10px 20px;">
            🔄 Làm mới biểu đồ
          </button>
          <button onclick="clearChartHistory()" style="width: auto; padding: 10px 20px; margin-left: 10px;" class="danger">
            🗑️ Xóa lịch sử
          </button>
        </div>
      `;
    }

    function renderTransferTab() {
      const accounts = JSON.parse(localStorage.getItem('walletAccounts') || '[]');
      const currentAcc = accounts.find(a => a.address.toLowerCase() === currentAccount.toLowerCase());
      const isDevAccount = currentAcc && currentAcc.type === 'dev';
      
      return `
        <h2>💸 Chuyển tiền</h2>
        ${isDevAccount ? '<p style="color: #0D9488; font-size: 13px; margin-bottom: 10px;">🔥 Dev Account - Không cần mật khẩu</p>' : ''}
        <input type="text" value="${currentAccount}" disabled />
        <input type="text" id="transferTo" placeholder="Địa chỉ nhận (0x...)" oninput="validateTransferAddress()" />
        
        <div id="addressValidation" class="address-validation"></div>
        <div id="phishingWarning" class="phishing-warning"></div>
        
        <input type="number" id="transferAmount" placeholder="Số ETH" step="0.001" oninput="calculateGasFee()" />
        
        <div id="gasFeeDisplay"></div>
        
        ${isDevAccount ? '' : '<input type="password" id="transferPassword" placeholder="Mật khẩu ví" />'}
        <button onclick="handleTransfer()" id="transferBtn">🚀 Gửi giao dịch</button>
        <div id="transferMessage"></div>
      `;
    }

   function renderContractTab() {
      const accounts = JSON.parse(localStorage.getItem('walletAccounts') || '[]');
      const currentAcc = accounts.find(a => a.address.toLowerCase() === currentAccount.toLowerCase());
      const isDevAccount = currentAcc && currentAcc.type === 'dev';
      
      return `
        <h2>📄 Triển khai Hợp đồng Thông minh</h2>
        ${isDevAccount ? '<p style="color: #0D9488; font-size: 13px; margin-bottom: 10px;">🔥 Dev Account - Không cần mật khẩu</p>' : ''}
        
        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">
            📝 Bytecode hợp đồng:
          </label>
          <textarea 
            id="contractBytecode" 
            placeholder="0x60806040..."
            style="width: 100%; min-height: 150px; padding: 12px; border-radius: 8px; border: 2px solid var(--border-color); font-family: 'Courier New', monospace; font-size: 13px; background: var(--bg-input); color: var(--text-primary); resize: vertical;"
          ></textarea>
          <small style="color: var(--text-secondary);">Nhập bytecode của hợp đồng đã được biên dịch (bắt đầu bằng 0x)</small>
        </div>

        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">
            🔧 Constructor Arguments (tùy chọn):
          </label>
          <input 
            type="text" 
            id="contractArgs" 
            placeholder='["arg1", "arg2"] hoặc để trống nếu không có'
            style="font-family: 'Courier New', monospace;"
          />
          <small style="color: var(--text-secondary);">Nhập các tham số constructor dưới dạng JSON array</small>
        </div>

        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">
            💰 Số ETH gửi kèm (tùy chọn):
          </label>
          <input 
            type="number" 
            id="contractValue" 
            placeholder="0.0" 
            step="0.001"
            oninput="calculateContractGasFee()"
          />
          <small style="color: var(--text-secondary);">Để 0 nếu hợp đồng không cần nhận ETH khi deploy</small>
        </div>

        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">
            ⛽ Gas Limit:
          </label>
          <input 
            type="number" 
            id="contractGasLimit" 
            placeholder="3000000" 
            value="3000000"
            oninput="calculateContractGasFee()"
          />
          <small style="color: var(--text-secondary);">Gas limit cho việc triển khai hợp đồng (mặc định: 3,000,000)</small>
        </div>

        <div id="contractGasFeeDisplay"></div>
        
        ${isDevAccount ? '' : '<input type="password" id="contractPassword" placeholder="Mật khẩu ví" />'}
        
        <button onclick="handleDeployContract()" id="deployBtn" style="background: linear-gradient(135deg, #10B981 0%, #059669 100%);">
          🚀 Triển khai Hợp đồng
        </button>
        
        <div id="contractMessage"></div>

        <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid var(--border-color);">
          <h3 style="margin-bottom: 15px; color: var(--text-primary);">📋 Hợp đồng đã triển khai</h3>
          <div id="deployedContractsList"></div>
        </div>
      `;
    }

    // ==================== ERC-20 TOKEN TAB ====================
    
    function renderERC20Tab() {
      const accounts = JSON.parse(localStorage.getItem('walletAccounts') || '[]');
      const currentAcc = accounts.find(a => a.address.toLowerCase() === currentAccount.toLowerCase());
      const isDevAccount = currentAcc && currentAcc.type === 'dev';
      
      return `
        <h2>🪙 Tương tác với ERC-20 Token</h2>
        ${isDevAccount ? '<p style="color: #0D9488; font-size: 13px; margin-bottom: 10px;">🔥 Dev Account - Không cần mật khẩu cho các giao dịch</p>' : ''}
        
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">
            📍 Địa chỉ Token Contract:
          </label>
          <input 
            type="text" 
            id="erc20ContractAddress" 
            placeholder="0x..."
            oninput="validateERC20Address()"
          />
          <div id="erc20AddressValidation" class="address-validation"></div>
          <button onclick="loadERC20Info()" style="margin-top: 10px;">
            🔍 Tải thông tin Token
          </button>
        </div>

        <div id="erc20InfoDisplay" style="display: none; margin-top: 20px; padding: 20px; background: var(--table-header); border-radius: 12px;">
          <h3 style="margin-bottom: 15px; color: var(--text-primary);">📊 Thông tin Token</h3>
          <div class="grid-2">
            <div>
              <div style="color: var(--text-secondary); font-size: 13px; margin-bottom: 5px;">Tên Token:</div>
              <div id="tokenName" style="font-weight: 600; font-size: 16px; color: var(--text-primary);">-</div>
            </div>
            <div>
              <div style="color: var(--text-secondary); font-size: 13px; margin-bottom: 5px;">Symbol:</div>
              <div id="tokenSymbol" style="font-weight: 600; font-size: 16px; color: var(--text-primary);">-</div>
            </div>
            <div>
              <div style="color: var(--text-secondary); font-size: 13px; margin-bottom: 5px;">Decimals:</div>
              <div id="tokenDecimals" style="font-weight: 600; font-size: 16px; color: var(--text-primary);">-</div>
            </div>
            <div>
              <div style="color: var(--text-secondary); font-size: 13px; margin-bottom: 5px;">Số dư của bạn:</div>
              <div id="tokenBalance" style="font-weight: 600; font-size: 16px; color: #4B5EAA;">-</div>
            </div>
          </div>
        </div>

        <div id="erc20ActionsPanel" style="display: none; margin-top: 30px;">
          <div style="border: 2px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
            <h3 style="margin-bottom: 15px; color: var(--text-primary);">💸 Transfer Token</h3>
            <input 
              type="text" 
              id="erc20TransferTo" 
              placeholder="Địa chỉ nhận (0x...)"
              oninput="validateERC20TransferAddress()"
            />
            <div id="erc20TransferValidation" class="address-validation"></div>
            <input 
              type="number" 
              id="erc20TransferAmount" 
              placeholder="Số lượng token" 
              step="any"
            />
            ${isDevAccount ? '' : '<input type="password" id="erc20TransferPassword" placeholder="Mật khẩu ví" />'}
            <button onclick="handleERC20Transfer()" class="success">
              🚀 Gửi Token
            </button>
            <div id="erc20TransferMessage"></div>
          </div>

          <div style="border: 2px solid var(--border-color); border-radius: 12px; padding: 20px;">
            <h3 style="margin-bottom: 15px; color: var(--text-primary);">✅ Approve Token</h3>
            <input 
              type="text" 
              id="erc20ApproveSpender" 
              placeholder="Địa chỉ được phép chi tiêu (0x...)"
              oninput="validateERC20ApproveAddress()"
            />
            <div id="erc20ApproveValidation" class="address-validation"></div>
            <input 
              type="number" 
              id="erc20ApproveAmount" 
              placeholder="Số lượng token cho phép" 
              step="any"
            />
            ${isDevAccount ? '' : '<input type="password" id="erc20ApprovePassword" placeholder="Mật khẩu ví" />'}
            <button onclick="handleERC20Approve()" style="background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);">
              ✅ Approve
            </button>
            <div id="erc20ApproveMessage"></div>
          </div>
        </div>

        <div id="erc20Message"></div>
      `;
    }

    // ERC-20 Standard ABI
    const ERC20_ABI = [
      {
        "constant": true,
        "inputs": [],
        "name": "name",
        "outputs": [{"name": "", "type": "string"}],
        "type": "function"
      },
      {
        "constant": true,
        "inputs": [],
        "name": "symbol",
        "outputs": [{"name": "", "type": "string"}],
        "type": "function"
      },
      {
        "constant": true,
        "inputs": [],
        "name": "decimals",
        "outputs": [{"name": "", "type": "uint8"}],
        "type": "function"
      },
      {
        "constant": true,
        "inputs": [{"name": "_owner", "type": "address"}],
        "name": "balanceOf",
        "outputs": [{"name": "balance", "type": "uint256"}],
        "type": "function"
      },
      {
        "constant": false,
        "inputs": [
          {"name": "_to", "type": "address"},
          {"name": "_value", "type": "uint256"}
        ],
        "name": "transfer",
        "outputs": [{"name": "", "type": "bool"}],
        "type": "function"
      },
      {
        "constant": false,
        "inputs": [
          {"name": "_spender", "type": "address"},
          {"name": "_value", "type": "uint256"}
        ],
        "name": "approve",
        "outputs": [{"name": "", "type": "bool"}],
        "type": "function"
      }
    ];

    let currentERC20Contract = null;
    let currentTokenDecimals = 18;

    function validateERC20Address() {
      const address = document.getElementById('erc20ContractAddress').value.trim();
      const validationDiv = document.getElementById('erc20AddressValidation');
      
      if (!address) {
        validationDiv.innerHTML = '';
        return;
      }

      const validation = validateAddress(address);
      
      if (validation.valid) {
        validationDiv.innerHTML = `
          <span class="validation-icon" style="color: #0D9488;">✅</span>
          <span style="color: #0D9488;">${validation.message}</span>
        `;
      } else {
        validationDiv.innerHTML = `
          <span class="validation-icon" style="color: #DC2626;">❌</span>
          <span style="color: #DC2626;">${validation.message}</span>
        `;
      }
    }

    async function loadERC20Info() {
      const address = document.getElementById('erc20ContractAddress').value.trim();
      const messageEl = document.getElementById('erc20Message');
      
      if (!address) {
        messageEl.innerHTML = '<div class="message error">❌ Vui lòng nhập địa chỉ contract</div>';
        return;
      }

      const validation = validateAddress(address);
      if (!validation.valid) {
        messageEl.innerHTML = `<div class="message error">${validation.message}</div>`;
        return;
      }

      messageEl.innerHTML = '<div class="message info">⏳ Đang tải thông tin token...</div>';

      try {
        const checksumAddress = web3.utils.toChecksumAddress(address);
        currentERC20Contract = new web3.eth.Contract(ERC20_ABI, checksumAddress);

        const [name, symbol, decimals, balance] = await Promise.all([
          currentERC20Contract.methods.name().call().catch(() => 'Unknown'),
          currentERC20Contract.methods.symbol().call().catch(() => 'N/A'),
          currentERC20Contract.methods.decimals().call().catch(() => 18),
          currentERC20Contract.methods.balanceOf(currentAccount).call()
        ]);

        currentTokenDecimals = Number(decimals);
        const formattedBalance = Number.parseFloat(balance) / Math.pow(10, currentTokenDecimals);

        document.getElementById('tokenName').textContent = name;
        document.getElementById('tokenSymbol').textContent = symbol;
        document.getElementById('tokenDecimals').textContent = decimals;
        document.getElementById('tokenBalance').textContent = formattedBalance.toFixed(6) + ' ' + symbol;

        document.getElementById('erc20InfoDisplay').style.display = 'block';
        document.getElementById('erc20ActionsPanel').style.display = 'block';
        messageEl.innerHTML = '<div class="message success">✅ Đã tải thông tin token thành công!</div>';

        logToBackend('ERC20_INFO_LOADED', {
          contract: checksumAddress,
          name,
          symbol,
          decimals,
          balance: formattedBalance,
          timestamp: new Date().toISOString()
        });

      } catch (err) {
        messageEl.innerHTML = `<div class="message error">❌ Lỗi: ${err.message}<br><small>Contract có thể không phải ERC-20 hoặc không tồn tại</small></div>`;
        document.getElementById('erc20InfoDisplay').style.display = 'none';
        document.getElementById('erc20ActionsPanel').style.display = 'none';
      }
    }

    function validateERC20TransferAddress() {
      const address = document.getElementById('erc20TransferTo').value.trim();
      const validationDiv = document.getElementById('erc20TransferValidation');
      
      if (!address) {
        validationDiv.innerHTML = '';
        return;
      }

      const validation = validateAddress(address);
      
      if (validation.valid) {
        validationDiv.innerHTML = `
          <span class="validation-icon" style="color: #0D9488;">✅</span>
          <span style="color: #0D9488;">${validation.message}</span>
        `;
      } else {
        validationDiv.innerHTML = `
          <span class="validation-icon" style="color: #DC2626;">❌</span>
          <span style="color: #DC2626;">${validation.message}</span>
        `;
      }
    }

    function validateERC20ApproveAddress() {
      const address = document.getElementById('erc20ApproveSpender').value.trim();
      const validationDiv = document.getElementById('erc20ApproveValidation');
      
      if (!address) {
        validationDiv.innerHTML = '';
        return;
      }

      const validation = validateAddress(address);
      
      if (validation.valid) {
        validationDiv.innerHTML = `
          <span class="validation-icon" style="color: #0D9488;">✅</span>
          <span style="color: #0D9488;">${validation.message}</span>
        `;
      } else {
        validationDiv.innerHTML = `
          <span class="validation-icon" style="color: #DC2626;">❌</span>
          <span style="color: #DC2626;">${validation.message}</span>
        `;
      }
    }

    async function handleERC20Transfer() {
      const to = document.getElementById('erc20TransferTo').value.trim();
      const amount = document.getElementById('erc20TransferAmount').value;
      const passwordInput = document.getElementById('erc20TransferPassword');
      const password = passwordInput ? passwordInput.value : '';
      const messageEl = document.getElementById('erc20TransferMessage');

      const accounts = JSON.parse(localStorage.getItem('walletAccounts') || '[]');
      const currentAcc = accounts.find(a => a.address.toLowerCase() === currentAccount.toLowerCase());
      const isDevAccount = currentAcc && currentAcc.type === 'dev';

      if (!currentERC20Contract) {
        messageEl.innerHTML = '<div class="message error">❌ Vui lòng tải thông tin token trước</div>';
        return;
      }

      if (!to || !amount) {
        messageEl.innerHTML = '<div class="message error">❌ Vui lòng nhập đầy đủ thông tin</div>';
        return;
      }

      const validation = validateAddress(to);
      if (!validation.valid) {
        messageEl.innerHTML = `<div class="message error">${validation.message}</div>`;
        return;
      }

      if (!isDevAccount && !password) {
        messageEl.innerHTML = '<div class="message error">❌ Vui lòng nhập mật khẩu</div>';
        return;
      }

      const checksumTo = web3.utils.toChecksumAddress(to);
      const amountInWei = (Number.parseFloat(amount) * Math.pow(10, currentTokenDecimals)).toString();

      const confirmMsg = `🔐 XÁC NHẬN CHUYỂN TOKEN\n\n` +
        `Từ: ${currentAccount}\n` +
        `Đến: ${checksumTo}\n` +
        `Số lượng: ${amount} tokens\n\n` +
        `Bạn có chắc chắn muốn thực hiện giao dịch này?`;
      
      if (!confirm(confirmMsg)) {
        messageEl.innerHTML = '<div class="message info">❌ Giao dịch đã bị hủy</div>';
        return;
      }

      messageEl.innerHTML = '<div class="message info">⏳ Đang gửi giao dịch...</div>';

      try {
        const account = accounts.find(a => a.address.toLowerCase() === currentAccount.toLowerCase());
        if (!account) throw new Error('Không tìm thấy tài khoản!');

        const data = currentERC20Contract.methods.transfer(checksumTo, amountInWei).encodeABI();
        const gasPrice = await web3.eth.getGasPrice();
        const gasLimit = await currentERC20Contract.methods.transfer(checksumTo, amountInWei).estimateGas({from: currentAccount});

        let receipt;

        if (isDevAccount) {
          const tx = {
            from: currentAccount,
            to: currentERC20Contract.options.address,
            data: data,
            gas: gasLimit,
            gasPrice: gasPrice
          };
          receipt = await web3.eth.sendTransaction(tx);
        } else {
          let decrypted;
          try {
            decrypted = web3.eth.accounts.decrypt(JSON.parse(account.encrypted), password);
          } catch {
            throw new Error('Mật khẩu không đúng!');
          }

          const tx = {
            from: currentAccount,
            to: currentERC20Contract.options.address,
            data: data,
            gas: gasLimit,
            gasPrice: gasPrice
          };

          const signedTx = await web3.eth.accounts.signTransaction(tx, decrypted.privateKey);
          receipt = await web3.eth.sendSignedTransaction(signedTx.rawTransaction);
        }

        const gasFeeWei = BigInt(gasPrice) * BigInt(receipt.gasUsed);
        const gasFeeEth = web3.utils.fromWei(gasFeeWei.toString(), 'ether');

        logToBackend('ERC20_TRANSFER', {
          contract: currentERC20Contract.options.address,
          from: currentAccount,
          to: checksumTo,
          amount: amount,
          hash: receipt.transactionHash,
          gasUsed: receipt.gasUsed,
          timestamp: new Date().toISOString()
        });

        messageEl.innerHTML = `
          <div class="message success">
            ✅ Chuyển token thành công!<br>
            <small>Hash: ${receipt.transactionHash}</small><br>
            <small>Gas sử dụng: ${receipt.gasUsed} (${Number.parseFloat(gasFeeEth).toFixed(6)} ETH)</small>
          </div>
        `;

        document.getElementById('erc20TransferTo').value = '';
        document.getElementById('erc20TransferAmount').value = '';
        if (passwordInput) passwordInput.value = '';
        document.getElementById('erc20TransferValidation').innerHTML = '';

        setTimeout(() => loadERC20Info(), 2000);

      } catch (err) {
        messageEl.innerHTML = `<div class="message error">❌ Lỗi: ${err.message}</div>`;
        
        logToBackend('ERC20_TRANSFER_FAILED', {
          contract: currentERC20Contract.options.address,
          from: currentAccount,
          to: checksumTo,
          amount: amount,
          error: err.message,
          timestamp: new Date().toISOString()
        });
      }
    }

    async function handleERC20Approve() {
      const spender = document.getElementById('erc20ApproveSpender').value.trim();
      const amount = document.getElementById('erc20ApproveAmount').value;
      const passwordInput = document.getElementById('erc20ApprovePassword');
      const password = passwordInput ? passwordInput.value : '';
      const messageEl = document.getElementById('erc20ApproveMessage');

      const accounts = JSON.parse(localStorage.getItem('walletAccounts') || '[]');
      const currentAcc = accounts.find(a => a.address.toLowerCase() === currentAccount.toLowerCase());
      const isDevAccount = currentAcc && currentAcc.type === 'dev';

      if (!currentERC20Contract) {
        messageEl.innerHTML = '<div class="message error">❌ Vui lòng tải thông tin token trước</div>';
        return;
      }

      if (!spender || !amount) {
        messageEl.innerHTML = '<div class="message error">❌ Vui lòng nhập đầy đủ thông tin</div>';
        return;
      }

      const validation = validateAddress(spender);
      if (!validation.valid) {
        messageEl.innerHTML = `<div class="message error">${validation.message}</div>`;
        return;
      }

      if (!isDevAccount && !password) {
        messageEl.innerHTML = '<div class="message error">❌ Vui lòng nhập mật khẩu</div>';
        return;
      }

      const checksumSpender = web3.utils.toChecksumAddress(spender);
      const amountInWei = (Number.parseFloat(amount) * Math.pow(10, currentTokenDecimals)).toString();

      const confirmMsg = `🔐 XÁC NHẬN APPROVE TOKEN\n\n` +
        `Chủ sở hữu: ${currentAccount}\n` +
        `Được phép chi tiêu: ${checksumSpender}\n` +
        `Số lượng: ${amount} tokens\n\n` +
        `⚠️ Lưu ý: Địa chỉ này sẽ có quyền chi tiêu token của bạn!\n\n` +
        `Bạn có chắc chắn muốn approve?`;
      
      if (!confirm(confirmMsg)) {
        messageEl.innerHTML = '<div class="message info">❌ Đã hủy approve</div>';
        return;
      }

      messageEl.innerHTML = '<div class="message info">⏳ Đang gửi giao dịch...</div>';

      try {
        const account = accounts.find(a => a.address.toLowerCase() === currentAccount.toLowerCase());
        if (!account) throw new Error('Không tìm thấy tài khoản!');

        const data = currentERC20Contract.methods.approve(checksumSpender, amountInWei).encodeABI();
        const gasPrice = await web3.eth.getGasPrice();
        const gasLimit = await currentERC20Contract.methods.approve(checksumSpender, amountInWei).estimateGas({from: currentAccount});

        let receipt;

        if (isDevAccount) {
          const tx = {
            from: currentAccount,
            to: currentERC20Contract.options.address,
            data: data,
            gas: gasLimit,
            gasPrice: gasPrice
          };
          receipt = await web3.eth.sendTransaction(tx);
        } else {
          let decrypted;
          try {
            decrypted = web3.eth.accounts.decrypt(JSON.parse(account.encrypted), password);
          } catch {
            throw new Error('Mật khẩu không đúng!');
          }

          const tx = {
            from: currentAccount,
            to: currentERC20Contract.options.address,
            data: data,
            gas: gasLimit,
            gasPrice: gasPrice
          };

          const signedTx = await web3.eth.accounts.signTransaction(tx, decrypted.privateKey);
          receipt = await web3.eth.sendSignedTransaction(signedTx.rawTransaction);
        }

        const gasFeeWei = BigInt(gasPrice) * BigInt(receipt.gasUsed);
        const gasFeeEth = web3.utils.fromWei(gasFeeWei.toString(), 'ether');

        logToBackend('ERC20_APPROVE', {
          contract: currentERC20Contract.options.address,
          owner: currentAccount,
          spender: checksumSpender,
          amount: amount,
          hash: receipt.transactionHash,
          gasUsed: receipt.gasUsed,
          timestamp: new Date().toISOString()
        });

        messageEl.innerHTML = `
          <div class="message success">
            ✅ Approve thành công!<br>
            <small>Hash: ${receipt.transactionHash}</small><br>
            <small>Gas sử dụng: ${receipt.gasUsed} (${Number.parseFloat(gasFeeEth).toFixed(6)} ETH)</small>
          </div>
        `;

        document.getElementById('erc20ApproveSpender').value = '';
        document.getElementById('erc20ApproveAmount').value = '';
        if (passwordInput) passwordInput.value = '';
        document.getElementById('erc20ApproveValidation').innerHTML = '';

      } catch (err) {
        messageEl.innerHTML = `<div class="message error">❌ Lỗi: ${err.message}</div>`;
        
        logToBackend('ERC20_APPROVE_FAILED', {
          contract: currentERC20Contract.options.address,
          owner: currentAccount,
          spender: checksumSpender,
          amount: amount,
          error: err.message,
          timestamp: new Date().toISOString()
        });
      }
    }

    // ==================== CONTRACT INTERACTION TAB ====================
    
    function renderInteractTab() {
      const accounts = JSON.parse(localStorage.getItem('walletAccounts') || '[]');
      const currentAcc = accounts.find(a => a.address.toLowerCase() === currentAccount.toLowerCase());
      const isDevAccount = currentAcc && currentAcc.type === 'dev';
      
      return `
        <h2>🔧 Tương tác với Hợp đồng</h2>
        ${isDevAccount ? '<p style="color: #0D9488; font-size: 13px; margin-bottom: 10px;">🔥 Dev Account - Không cần mật khẩu cho các giao dịch</p>' : ''}
        
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">
            📍 Địa chỉ Contract:
          </label>
          <input 
            type="text" 
            id="interactContractAddress" 
            placeholder="0x..."
            oninput="validateInteractAddress()"
          />
          <div id="interactAddressValidation" class="address-validation"></div>
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">
            📋 Contract ABI (JSON):
          </label>
          <textarea 
            id="interactContractABI" 
            placeholder='[{"constant":true,"inputs":[],"name":"name",...}]'
            style="width: 100%; min-height: 200px; padding: 12px; border-radius: 8px; border: 2px solid var(--border-color); font-family: 'Courier New', monospace; font-size: 12px; background: var(--bg-input); color: var(--text-primary); resize: vertical;"
          ></textarea>
          <small style="color: var(--text-secondary);">Nhập ABI của hợp đồng dưới dạng JSON array</small>
        </div>

        <button onclick="loadContractInterface()" style="margin-bottom: 20px;">
          🔍 Tải giao diện Contract
        </button>

        <div id="interactMessage"></div>

        <div id="contractInterfacePanel" style="display: none; margin-top: 30px;">
          <div style="border: 2px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
            <h3 style="margin-bottom: 15px; color: var(--text-primary);">👁️ Read Functions (View/Pure)</h3>
            <div id="readFunctionsList"></div>
          </div>

          <div style="border: 2px solid var(--border-color); border-radius: 12px; padding: 20px;">
            <h3 style="margin-bottom: 15px; color: var(--text-primary);">✍️ Write Functions (Transactions)</h3>
            <div id="writeFunctionsList"></div>
          </div>
        </div>
      `;
    }

    let currentInteractContract = null;
    let currentContractABI = null;

    function validateInteractAddress() {
      const address = document.getElementById('interactContractAddress').value.trim();
      const validationDiv = document.getElementById('interactAddressValidation');
      
      if (!address) {
        validationDiv.innerHTML = '';
        return;
      }

      const validation = validateAddress(address);
      
      if (validation.valid) {
        validationDiv.innerHTML = `
          <span class="validation-icon" style="color: #0D9488;">✅</span>
          <span style="color: #0D9488;">${validation.message}</span>
        `;
      } else {
        validationDiv.innerHTML = `
          <span class="validation-icon" style="color: #DC2626;">❌</span>
          <span style="color: #DC2626;">${validation.message}</span>
        `;
      }
    }

    async function loadContractInterface() {
      const address = document.getElementById('interactContractAddress').value.trim();
      const abiInput = document.getElementById('interactContractABI').value.trim();
      const messageEl = document.getElementById('interactMessage');

      if (!address || !abiInput) {
        messageEl.innerHTML = '<div class="message error">❌ Vui lòng nhập đầy đủ địa chỉ và ABI</div>';
        return;
      }

      const validation = validateAddress(address);
      if (!validation.valid) {
        messageEl.innerHTML = `<div class="message error">${validation.message}</div>`;
        return;
      }

      try {
        currentContractABI = JSON.parse(abiInput);
        if (!Array.isArray(currentContractABI)) {
          throw new TypeError('ABI phải là một JSON array');
        }
      } catch (err) {
        messageEl.innerHTML = `<div class="message error">❌ ABI không hợp lệ: ${err.message}</div>`;
        return;
      }

      messageEl.innerHTML = '<div class="message info">⏳ Đang tải giao diện contract...</div>';

      try {
        const checksumAddress = web3.utils.toChecksumAddress(address);
        currentInteractContract = new web3.eth.Contract(currentContractABI, checksumAddress);

        const readFunctions = currentContractABI.filter(item => 
          item.type === 'function' && (item.stateMutability === 'view' || item.stateMutability === 'pure' || item.constant === true)
        );

        const writeFunctions = currentContractABI.filter(item => 
          item.type === 'function' && item.stateMutability !== 'view' && item.stateMutability !== 'pure' && item.constant !== true
        );

        renderReadFunctions(readFunctions);
        renderWriteFunctions(writeFunctions);

        document.getElementById('contractInterfacePanel').style.display = 'block';
        messageEl.innerHTML = `<div class="message success">✅ Đã tải ${readFunctions.length} read functions và ${writeFunctions.length} write functions</div>`;

        logToBackend('CONTRACT_INTERFACE_LOADED', {
          contract: checksumAddress,
          readFunctions: readFunctions.length,
          writeFunctions: writeFunctions.length,
          timestamp: new Date().toISOString()
        });

      } catch (err) {
        messageEl.innerHTML = `<div class="message error">❌ Lỗi: ${err.message}</div>`;
      }
    }

    function renderReadFunctions(functions) {
      const container = document.getElementById('readFunctionsList');
      
      if (functions.length === 0) {
        container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">Không có read function nào</p>';
        return;
      }

      container.innerHTML = functions.map((func, index) => `
        <div style="background: var(--table-header); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
          <div style="font-weight: 600; font-size: 15px; margin-bottom: 10px; color: var(--text-primary);">
            📖 ${func.name}
          </div>
          ${func.inputs && func.inputs.length > 0 ? `
            <div style="margin-bottom: 10px;">
              ${func.inputs.map((input, inputIndex) => `
                <input 
                  type="text" 
                  id="read_${index}_${inputIndex}" 
                  placeholder="${input.name || 'param' + inputIndex} (${input.type})"
                  style="margin-bottom: 8px;"
                />
              `).join('')}
            </div>
          ` : ''}
          <button onclick="callReadFunction(${index})" style="width: auto; padding: 8px 16px; margin-right: 10px;">
            🔍 Call
          </button>
          <div id="read_result_${index}" style="margin-top: 10px;"></div>
        </div>
      `).join('');
    }

    function renderWriteFunctions(functions) {
      const container = document.getElementById('writeFunctionsList');
      const accounts = JSON.parse(localStorage.getItem('walletAccounts') || '[]');
      const currentAcc = accounts.find(a => a.address.toLowerCase() === currentAccount.toLowerCase());
      const isDevAccount = currentAcc && currentAcc.type === 'dev';
      
      if (functions.length === 0) {
        container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">Không có write function nào</p>';
        return;
      }

      container.innerHTML = functions.map((func, index) => `
        <div style="background: var(--table-header); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
          <div style="font-weight: 600; font-size: 15px; margin-bottom: 10px; color: var(--text-primary);">
            ✍️ ${func.name}
          </div>
          ${func.inputs && func.inputs.length > 0 ? `
            <div style="margin-bottom: 10px;">
              ${func.inputs.map((input, inputIndex) => `
                <input 
                  type="text" 
                  id="write_${index}_${inputIndex}" 
                  placeholder="${input.name || 'param' + inputIndex} (${input.type})"
                  style="margin-bottom: 8px;"
                />
              `).join('')}
            </div>
          ` : ''}
          ${func.payable || func.stateMutability === 'payable' ? `
            <input 
              type="number" 
              id="write_value_${index}" 
              placeholder="ETH to send (payable function)" 
              step="0.001"
              style="margin-bottom: 8px;"
            />
          ` : ''}
          ${isDevAccount ? '' : `
            <input 
              type="password" 
              id="write_password_${index}" 
              placeholder="Mật khẩu ví" 
              style="margin-bottom: 8px;"
            />
          `}
          <button onclick="callWriteFunction(${index})" class="success" style="width: auto; padding: 8px 16px; margin-right: 10px;">
            🚀 Execute
          </button>
          <div id="write_result_${index}" style="margin-top: 10px;"></div>
        </div>
      `).join('');
    }

    async function callReadFunction(functionIndex) {
      const func = currentContractABI.filter(item => 
        item.type === 'function' && (item.stateMutability === 'view' || item.stateMutability === 'pure' || item.constant === true)
      )[functionIndex];
      
      const resultDiv = document.getElementById(`read_result_${functionIndex}`);
      resultDiv.innerHTML = '<div class="message info">⏳ Đang gọi function...</div>';

      try {
        const params = [];
        if (func.inputs && func.inputs.length > 0) {
          for (let i = 0; i < func.inputs.length; i++) {
            const value = document.getElementById(`read_${functionIndex}_${i}`).value.trim();
            if (!value) {
              throw new Error(`Vui lòng nhập ${func.inputs[i].name || 'tham số ' + i}`);
            }
            params.push(value);
          }
        }

        const result = await currentInteractContract.methods[func.name](...params).call();
        
        let displayResult;
        if (typeof result === 'object' && result !== null) {
          displayResult = JSON.stringify(result, null, 2);
        } else {
          displayResult = result.toString();
        }

        resultDiv.innerHTML = `
          <div class="message success">
            <div style="font-weight: 600; margin-bottom: 5px;">✅ Kết quả:</div>
            <div style="font-family: 'Courier New', monospace; font-size: 13px; background: var(--bg-input); padding: 10px; border-radius: 6px; word-break: break-all;">
              ${displayResult}
            </div>
          </div>
        `;

        logToBackend('READ_FUNCTION_CALLED', {
          contract: currentInteractContract.options.address,
          function: func.name,
          params,
          result: displayResult,
          timestamp: new Date().toISOString()
        });

      } catch (err) {
        resultDiv.innerHTML = `<div class="message error">❌ Lỗi: ${err.message}</div>`;
      }
    }

    async function callWriteFunction(functionIndex) {
      const func = currentContractABI.filter(item => 
        item.type === 'function' && item.stateMutability !== 'view' && item.stateMutability !== 'pure' && item.constant !== true
      )[functionIndex];
      
      const resultDiv = document.getElementById(`write_result_${functionIndex}`);
      const accounts = JSON.parse(localStorage.getItem('walletAccounts') || '[]');
      const currentAcc = accounts.find(a => a.address.toLowerCase() === currentAccount.toLowerCase());
      const isDevAccount = currentAcc && currentAcc.type === 'dev';

      try {
        const params = [];
        if (func.inputs && func.inputs.length > 0) {
          for (let i = 0; i < func.inputs.length; i++) {
            const value = document.getElementById(`write_${functionIndex}_${i}`).value.trim();
            if (!value) {
              throw new Error(`Vui lòng nhập ${func.inputs[i].name || 'tham số ' + i}`);
            }
            params.push(value);
          }
        }

        let valueWei = '0';
        if (func.payable || func.stateMutability === 'payable') {
          const valueInput = document.getElementById(`write_value_${functionIndex}`);
          if (valueInput && valueInput.value) {
            valueWei = web3.utils.toWei(valueInput.value, 'ether');
          }
        }

        let password = '';
        if (!isDevAccount) {
          const passwordInput = document.getElementById(`write_password_${functionIndex}`);
          password = passwordInput ? passwordInput.value : '';
          if (!password) {
            throw new Error('Vui lòng nhập mật khẩu');
          }
        }

        const confirmMsg = `🔐 XÁC NHẬN THỰC THI FUNCTION\n\n` +
          `Contract: ${currentInteractContract.options.address}\n` +
          `Function: ${func.name}\n` +
          `Parameters: ${JSON.stringify(params)}\n` +
          `${valueWei !== '0' ? `Value: ${web3.utils.fromWei(valueWei, 'ether')} ETH\n` : ''}` +
          `\nBạn có chắc chắn muốn thực hiện?`;
        
        if (!confirm(confirmMsg)) {
          resultDiv.innerHTML = '<div class="message info">❌ Đã hủy thực thi</div>';
          return;
        }

        resultDiv.innerHTML = '<div class="message info">⏳ Đang gửi transaction...</div>';

        const data = currentInteractContract.methods[func.name](...params).encodeABI();
        const gasPrice = await web3.eth.getGasPrice();
        const gasLimit = await currentInteractContract.methods[func.name](...params).estimateGas({
          from: currentAccount,
          value: valueWei
        });

        let receipt;

        if (isDevAccount) {
          const tx = {
            from: currentAccount,
            to: currentInteractContract.options.address,
            data: data,
            gas: gasLimit,
            gasPrice: gasPrice,
            value: valueWei
          };
          receipt = await web3.eth.sendTransaction(tx);
        } else {
          const account = accounts.find(a => a.address.toLowerCase() === currentAccount.toLowerCase());
          if (!account) throw new Error('Không tìm thấy tài khoản!');

          let decrypted;
          try {
            decrypted = web3.eth.accounts.decrypt(JSON.parse(account.encrypted), password);
          } catch {
            throw new Error('Mật khẩu không đúng!');
          }

          const tx = {
            from: currentAccount,
            to: currentInteractContract.options.address,
            data: data,
            gas: gasLimit,
            gasPrice: gasPrice,
            value: valueWei
          };

          const signedTx = await web3.eth.accounts.signTransaction(tx, decrypted.privateKey);
          receipt = await web3.eth.sendSignedTransaction(signedTx.rawTransaction);
        }

        const gasFeeWei = BigInt(gasPrice) * BigInt(receipt.gasUsed);
        const gasFeeEth = web3.utils.fromWei(gasFeeWei.toString(), 'ether');

        logToBackend('WRITE_FUNCTION_CALLED', {
          contract: currentInteractContract.options.address,
          function: func.name,
          params,
          hash: receipt.transactionHash,
          gasUsed: receipt.gasUsed,
          timestamp: new Date().toISOString()
        });

        resultDiv.innerHTML = `
          <div class="message success">
            ✅ Transaction thành công!<br>
            <small>Hash: ${receipt.transactionHash}</small><br>
            <small>Gas sử dụng: ${receipt.gasUsed} (${Number.parseFloat(gasFeeEth).toFixed(6)} ETH)</small>
          </div>
        `;

        // Clear inputs
if (func.inputs) {
  for (const [i, _] of func.inputs.entries()) {
    document.getElementById(`write_${functionIndex}_${i}`).value = '';
  }
}
if (func.payable || func.stateMutability === 'payable') {
  const valueInput = document.getElementById(`write_value_${functionIndex}`);
  if (valueInput) valueInput.value = '';
}
if (!isDevAccount) {
  const passwordInput = document.getElementById(`write_password_${functionIndex}`);
  if (passwordInput) passwordInput.value = '';
}

} catch (err) {
  resultDiv.innerHTML = `<div class="message error">❌ Lỗi: ${err.message}</div>`;
  
  logToBackend('WRITE_FUNCTION_FAILED', {
    contract: currentInteractContract.options.address,
    function: func.name,
    error: err.message,
    timestamp: new Date().toISOString()
  });
}
}
    
    function renderHistoryRows(history) {
      return history.map(tx => {
        const txJson = JSON.stringify(tx).replaceAll("'", "&#39;").replaceAll('"', "&quot;");
        return `
          <tr onclick='event.stopPropagation(); showTransactionDetail(${txJson})' style="cursor: pointer;">
            <td>${new Date(tx.timestamp).toLocaleString('vi-VN')}</td>
            <td class="address">${tx.from.slice(0, 10)}...</td>
            <td class="address">${tx.to.slice(0, 10)}...</td>
            <td style="text-align: right; font-weight: bold;">${tx.value} ETH</td>
            <td style="text-align: center;">
              <span class="status-badge ${tx.status === 'success' ? 'status-success' : 'status-failed'}">
                ${tx.status === 'success' ? '✓' : '✗'}
              </span>
            </td>
          </tr>
        `;
      }).join('');
    }

    function renderLogsTab() {
      const logs = JSON.parse(localStorage.getItem('gethLogs') || '[]');
      
      if (logs.length === 0) {
        return '<h2>📊 Backend Logs</h2><p style="text-align: center; color: var(--text-secondary); padding: 40px;">Chưa có log nào</p>';
      }

      return `
        <h2>📊 Backend Logs</h2>
        <div style="max-height: 500px; overflow-y: auto;">
          ${logs.map(log => `
            <div class="log-entry">
              <div class="log-header">
                <span style="color: #6366F1;">${log.event}</span>
                <span style="font-size: 12px; color: var(--text-secondary);">${new Date(log.timestamp).toLocaleString('vi-VN')}</span>
              </div>
              <div class="log-data">${JSON.stringify(log.data, null, 2)}</div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // ==================== ADDRESS VALIDATION ====================
    
    function validateTransferAddress() {
      const address = document.getElementById('transferTo').value.trim();
      const validationDiv = document.getElementById('addressValidation');
      const transferBtn = document.getElementById('transferBtn');
      
      if (!address) {
        validationDiv.innerHTML = '';
        showPhishingWarning([]);
        return;
      }

      const validation = validateAddress(address);
      
      if (validation.valid) {
        validationDiv.innerHTML = `
          <span class="validation-icon" style="color: #0D9488;">✅</span>
          <span style="color: #0D9488;">${validation.message}</span>
        `;
        
        // Kiểm tra phishing patterns
        const warnings = checkPhishingPattern(address);
        showPhishingWarning(warnings);
        
        if (warnings.length > 0) {
          transferBtn.disabled = false;
          transferBtn.style.background = 'linear-gradient(135deg, #F59E0B 0%, #D97706 100%)';
        } else {
          transferBtn.disabled = false;
          transferBtn.style.background = 'var(--button-primary)';
        }
        
        calculateGasFee();
      } else {
        validationDiv.innerHTML = `
          <span class="validation-icon" style="color: #DC2626;">❌</span>
          <span style="color: #DC2626;">${validation.message}</span>
          ${validation.corrected ? `<br><small style="color: var(--text-secondary); margin-left: 26px;">Địa chỉ đúng: ${validation.corrected}</small>` : ''}
        `;
        showPhishingWarning([]);
        transferBtn.disabled = true;
        document.getElementById('gasFeeDisplay').innerHTML = '';
      }
    }

    // ==================== MODAL FUNCTIONS ====================
    
    function showWalletInfo() {
      const modal = document.getElementById('walletInfoModal');
      const modalBody = document.getElementById('walletInfoBody');
      
      modalBody.innerHTML = renderWalletInfo();
      modal.classList.add('show');
    }

    function searchWalletTransaction() {
      const searchTerm = document.getElementById('walletSearchTx').value.toLowerCase().trim();
      const history = JSON.parse(localStorage.getItem('txHistory') || '[]');
      const walletHistory = history.filter(tx => 
        tx.from.toLowerCase() === currentAccount.toLowerCase() || 
        tx.to.toLowerCase() === currentAccount.toLowerCase()
      );
      
      if (!searchTerm) {
        document.getElementById('walletHistoryTableBody').innerHTML = renderHistoryRows(walletHistory);
        return;
      }

      const filtered = walletHistory.filter(tx => 
        tx.hash.toLowerCase().includes(searchTerm) ||
        tx.from.toLowerCase().includes(searchTerm) ||
        tx.to.toLowerCase().includes(searchTerm)
      );

      const tbody = document.getElementById('walletHistoryTableBody');
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px; color: var(--text-secondary);">Không tìm thấy giao dịch nào</td></tr>';
      } else {
        tbody.innerHTML = renderHistoryRows(filtered);
      }
    }
    
    function showTransactionDetail(tx) {
      // KHÔNG đóng modal wallet info, chỉ hiển thị modal chi tiết phía trên
      const modal = document.getElementById('txDetailModal');
      const modalBody = document.getElementById('modalBody');
      
      modalBody.innerHTML = `
        <table style="width: 100%; border-collapse: collapse;">
          <tr>
            <td style="border: none; padding: 12px 0; width: 35%; vertical-align: top;">
              <span class="detail-label" style="font-size: 14px;">🔗 Transaction Hash:</span>
            </td>
            <td style="border: none; padding: 12px 0 12px 12px; word-break: break-all; font-family: 'Courier New', monospace; font-size: 13px; color: var(--text-primary); text-align: right;">
              ${tx.hash || 'N/A'}
            </td>
          </tr>
          <tr>
            <td style="border: none; padding: 12px 0; width: 35%; vertical-align: top;">
              <span class="detail-label" style="font-size: 14px;">📤 Từ:</span>
            </td>
            <td style="border: none; padding: 12px 0 12px 12px; word-break: break-all; font-family: 'Courier New', monospace; font-size: 13px; color: var(--text-primary); text-align: right;">
              ${tx.from}
            </td>
          </tr>
          <tr>
            <td style="border: none; padding: 12px 0; width: 35%; vertical-align: top;">
              <span class="detail-label" style="font-size: 14px;">📥 Đến:</span>
            </td>
            <td style="border: none; padding: 12px 0 12px 12px; word-break: break-all; font-family: 'Courier New', monospace; font-size: 13px; color: var(--text-primary); text-align: right;">
              ${tx.to}
            </td>
          </tr>
          <tr>
            <td style="border: none; padding: 12px 0;">
              <span class="detail-label" style="font-size: 14px;">💰 Số tiền:</span>
            </td>
            <td style="border: none; padding: 12px 0 12px 12px; color: #4B5EAA; font-weight: 600; font-size: 17px; text-align: right;">
              ${tx.value} ETH
            </td>
          </tr>
          <tr>
            <td style="border: none; padding: 12px 0;">
              <span class="detail-label" style="font-size: 14px;">⛽ Gas Fee:</span>
            </td>
            <td style="border: none; padding: 12px 0 12px 12px; color: var(--text-primary); font-size: 14px; text-align: right;">
              ${tx.gasFee || 'N/A'} ETH
            </td>
          </tr>
          <tr>
            <td style="border: none; padding: 12px 0;">
              <span class="detail-label" style="font-size: 14px;">⚡ Gas Price:</span>
            </td>
            <td style="border: none; padding: 12px 0 12px 12px; color: var(--text-primary); font-size: 14px; text-align: right;">
              ${tx.gasPrice || 'N/A'} Gwei
            </td>
          </tr>
          <tr>
            <td style="border: none; padding: 12px 0;">
              <span class="detail-label" style="font-size: 14px;">📦 Block Number:</span>
            </td>
            <td style="border: none; padding: 12px 0 12px 12px; color: var(--text-primary); font-size: 14px; text-align: right;">
              ${tx.blockNumber || 'N/A'}
            </td>
          </tr>
          <tr>
            <td style="border: none; padding: 12px 0;">
              <span class="detail-label" style="font-size: 14px;">🕐 Thời gian:</span>
            </td>
            <td style="border: none; padding: 12px 0 12px 12px; color: var(--text-primary); font-size: 14px; text-align: right;">
              ${new Date(tx.timestamp).toLocaleString('vi-VN')}
            </td>
          </tr>
          <tr>
            <td style="border: none; padding: 12px 0;">
              <span class="detail-label" style="font-size: 14px;">✅ Trạng thái:</span>
            </td>
            <td style="border: none; padding: 12px 0 12px 12px; text-align: right;">
              <span class="status-badge ${tx.status === 'success' ? 'status-success' : 'status-failed'}">
                ${tx.status === 'success' ? '✓ Thành công' : '✗ Thất bại'}
              </span>
            </td>
          </tr>
        </table>
      `;
      
      modal.classList.add('show');
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      modal.classList.remove('show');
    }

    function copyToClipboard(text, button) {
      navigator.clipboard.writeText(text).then(() => {
        const originalText = button.innerHTML;
        button.innerHTML = '✓';
        button.classList.add('copied');
        
        setTimeout(() => {
          button.innerHTML = originalText;
          button.classList.remove('copied');
        }, 2000);
      }).catch(err => {
        console.error('Copy failed:', err);
        alert('Không thể copy: ' + err.message);
      });
    }

    globalThis.addEventListener('click', function(event) {
      const txModal = document.getElementById('txDetailModal');
      const walletModal = document.getElementById('walletInfoModal');
      
      // Click vào background của modal chi tiết → chỉ đóng modal chi tiết
      if (event.target === txModal) {
        closeModal('txDetailModal');
      }
      
      // Click vào background của modal ví → đóng cả hai modal
      if (event.target === walletModal) {
        closeModal('txDetailModal');
        closeModal('walletInfoModal');
      }
    });

    function toggleBalanceVisibility() {
      balanceVisible = !balanceVisible;
      updateBalanceDisplay();
    }

    function updateBalanceDisplay() {
      const balanceEl = document.getElementById('currentBalance');
      if (!balanceEl) return;
      
      if (balanceVisible) {
        balanceEl.textContent = currentBalanceValue + ' ETH';
        balanceEl.classList.remove('balance-hidden');
      } else {
        balanceEl.textContent = '••••••';
        balanceEl.classList.add('balance-hidden');
      }
    }

    // ==================== EVENT HANDLERS ====================
    
    function switchAuthMode(mode) {
      localStorage.setItem('authMode', mode);
      render();
    }

    function switchTab(tab) {
  localStorage.setItem('dashboardTab', tab);
  updateTabActiveState(tab);
  updateTabContent(tab);
}

function updateTabActiveState(tab) {
  const tabs = document.querySelectorAll('.tab');
  for (const t of tabs) {
    t.classList.remove('active');
  }
  
  for (const t of tabs) {
    if (t.textContent.includes('Biểu đồ') && tab === 'chart') t.classList.add('active');
    if (t.textContent.includes('Chuyển tiền') && tab === 'transfer') t.classList.add('active');
    if (t.textContent.includes('ERC-20') && tab === 'erc20') t.classList.add('active');
    if (t.textContent.includes('Deploy') && tab === 'contract') t.classList.add('active');
    if (t.textContent.includes('Interact') && tab === 'interact') t.classList.add('active');
    if (t.textContent.includes('Logs') && tab === 'logs') t.classList.add('active');
  }
}

function updateTabContent(tab) {
  const content = document.getElementById('tabContent');
  
  if (tab === 'chart') {
    content.innerHTML = renderChartTab();
    setTimeout(() => renderBalanceChart(), 100);
  }
  else if (tab === 'transfer') {
    content.innerHTML = renderTransferTab();
  }
  else if (tab === 'erc20') {
    content.innerHTML = renderERC20Tab();
  }
  else if (tab === 'contract') {
    content.innerHTML = renderContractTab();
    setTimeout(() => renderDeployedContractsList(), 100);
  }
  else if (tab === 'interact') {
    content.innerHTML = renderInteractTab();
  }
  else if (tab === 'logs') {
    content.innerHTML = renderLogsTab();
  }
}

    // ==================== CHART FUNCTIONS ====================
    
    let balanceChartInstance = null;
    
    async function renderBalanceChart() {
      const canvas = document.getElementById('balanceChart');
      const messageEl = document.getElementById('chartLoadingMessage');
      if (!canvas) return;
      
      const history = getBalanceHistory(currentAccount);
      
      if (history.length === 0) {
        if (messageEl) {
          messageEl.innerHTML = '<div class="message info">⏳ Đang khởi tạo dữ liệu biểu đồ...</div>';
        }
        
        try {
          const balance = await getBalance(currentAccount);
          saveBalanceHistory(currentAccount, balance);
          setTimeout(() => renderBalanceChart(), 500);
          return;
        } catch (err) {
          canvas.parentElement.innerHTML = '<p style="text-align: center; color: #DC2626; padding: 40px;">❌ Lỗi tải dữ liệu: ' + err.message + '</p>';
          return;
        }
      }

      if (messageEl) {
        messageEl.innerHTML = '';
      }

      if (balanceChartInstance) {
        balanceChartInstance.destroy();
      }

      const ctx = canvas.getContext('2d');
      const root = document.documentElement;
      const theme = root.dataset.theme || 'light';
      const gridColor = theme === 'dark' ? 'rgba(75, 85, 99, 0.3)' : 'rgba(0, 0, 0, 0.05)';
      const textColor = theme === 'dark' ? '#D1D5DB' : '#6B7280';
      
      const labels = history.map(item => {
        const date = new Date(item.timestamp);
        return date.toLocaleString('vi-VN', { 
          month: 'short', 
          day: 'numeric', 
          hour: '2-digit', 
          minute: '2-digit' 
        });
      });
      
      const data = history.map(item => item.balance);

      balanceChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Số dư (ETH)',
            data: data,
            borderColor: '#6366F1',
            backgroundColor: 'rgba(99, 102, 241, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointRadius: 4,
            pointHoverRadius: 6,
            pointBackgroundColor: '#6366F1',
            pointBorderColor: '#FFFFFF',
            pointBorderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                font: { size: 14, weight: 'bold' },
                color: textColor
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#FFFFFF',
              bodyColor: '#FFFFFF',
              padding: 12,
              cornerRadius: 8,
              displayColors: false,
              callbacks: {
                label: function(context) {
                  return 'Số dư: ' + context.parsed.y.toFixed(6) + ' ETH';
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: false,
              ticks: {
                callback: function(value) {
                  return value.toFixed(4) + ' ETH';
                },
                color: textColor,
                font: { size: 12 }
              },
              grid: {
                color: gridColor
              }
            },
            x: {
              ticks: {
                maxRotation: 45,
                minRotation: 45,
                color: textColor,
                font: { size: 11 }
              },
              grid: {
                display: false
              }
            }
          }
        }
      });
    }

    async function refreshChart() {
      const balance = await getBalance(currentAccount);
      saveBalanceHistory(currentAccount, balance);
      renderBalanceChart();
    }

    function clearChartHistory() {
      if (confirm('Bạn có chắc chắn muốn xóa toàn bộ lịch sử biểu đồ?')) {
        const historyKey = `balanceHistory_${currentAccount}`;
        localStorage.removeItem(historyKey);
        renderBalanceChart();
      }
    }

    // ==================== TRANSACTION FUNCTIONS ====================
    
    async function calculateContractGasFee() {
      const value = document.getElementById('contractValue').value || '0';
      const gasLimit = document.getElementById('contractGasLimit').value || '3000000';
      const displayEl = document.getElementById('contractGasFeeDisplay');

      if (!gasLimit || gasLimit <= 0) {
        displayEl.innerHTML = '';
        return;
      }

      try {
        const gasPrice = await web3.eth.getGasPrice();
        const gasFeeWei = BigInt(gasPrice) * BigInt(gasLimit);
        const gasFeeEth = web3.utils.fromWei(gasFeeWei.toString(), 'ether');
        const total = (Number.parseFloat(value) + Number.parseFloat(gasFeeEth)).toFixed(6);
        
        displayEl.innerHTML = `
          <div class="gas-fee-box">
            <div style="font-weight: bold; margin-bottom: 10px; color: var(--text-primary);">⛽ Chi phí triển khai</div>
            <div class="gas-fee-row">
              <span>Gas Price:</span>
              <span>${Number.parseFloat(web3.utils.fromWei(gasPrice, 'gwei')).toFixed(2)} Gwei</span>
            </div>
            <div class="gas-fee-row">
              <span>Gas Limit:</span>
              <span>${gasLimit}</span>
            </div>
            <div class="gas-fee-row">
              <span>Gas Fee:</span>
              <span>${Number.parseFloat(gasFeeEth).toFixed(6)} ETH</span>
            </div>
            ${value > 0 ? `<div class="gas-fee-row">
              <span>ETH gửi kèm:</span>
              <span>${value} ETH</span>
            </div>` : ''}
            <div class="gas-fee-row total">
              <span>Tổng cộng:</span>
              <span>${total} ETH</span>
            </div>
          </div>
        `;
      } catch (err) {
        displayEl.innerHTML = `<div class="message error">❌ ${err.message}</div>`;
      }
    }

    async function handleDeployContract() {
      const bytecode = document.getElementById('contractBytecode').value.trim();
      const argsInput = document.getElementById('contractArgs').value.trim();
      const value = document.getElementById('contractValue').value || '0';
      const gasLimit = document.getElementById('contractGasLimit').value || '3000000';
      const passwordInput = document.getElementById('contractPassword');
      const password = passwordInput ? passwordInput.value : '';
      const messageEl = document.getElementById('contractMessage');

      const accounts = JSON.parse(localStorage.getItem('walletAccounts') || '[]');
      const currentAcc = accounts.find(a => a.address.toLowerCase() === currentAccount.toLowerCase());
      const isDevAccount = currentAcc && currentAcc.type === 'dev';

      if (!bytecode) {
        messageEl.innerHTML = '<div class="message error">❌ Vui lòng nhập bytecode hợp đồng</div>';
        return;
      }

      if (!bytecode.startsWith('0x')) {
        messageEl.innerHTML = '<div class="message error">❌ Bytecode phải bắt đầu bằng 0x</div>';
        return;
      }

      if (!isDevAccount && !password) {
        messageEl.innerHTML = '<div class="message error">❌ Vui lòng nhập mật khẩu</div>';
        return;
      }

      let args = [];
      if (argsInput) {
        try {
          args = JSON.parse(argsInput);
          if (!Array.isArray(args)) {
            throw new TypeError('Arguments phải là array');
          }
        } catch (err) {
          messageEl.innerHTML = '<div class="message error">❌ Constructor arguments không hợp lệ (phải là JSON array)</div>';
          return;
        }
      }

      const confirmMsg = `🔍 XÁC NHẬN TRIỂN KHAI HỢP ĐỒNG\n\n` +
        `Từ: ${currentAccount}\n` +
        `Gas Limit: ${gasLimit}\n` +
        `ETH gửi kèm: ${value} ETH\n\n` +
        `Bạn có chắc chắn muốn triển khai hợp đồng này?`;
      
      if (!confirm(confirmMsg)) {
        messageEl.innerHTML = '<div class="message info">❌ Đã hủy triển khai</div>';
        return;
      }

      messageEl.innerHTML = '<div class="message info">⏳ Đang triển khai hợp đồng...</div>';

      try {
        const account = accounts.find(a => a.address.toLowerCase() === currentAccount.toLowerCase());
        if (!account) throw new Error('Không tìm thấy tài khoản!');

        const valueWei = value > 0 ? web3.utils.toWei(value.toString(), 'ether') : '0';
        const gasPrice = await web3.eth.getGasPrice();

        let receipt;
        let contractAddress;

        if (isDevAccount) {
          const tx = {
            from: currentAccount,
            data: bytecode,
            gas: gasLimit,
            gasPrice: gasPrice,
            value: valueWei
          };

          receipt = await web3.eth.sendTransaction(tx);
          contractAddress = receipt.contractAddress;
        } else {
          let decrypted;
          try {
            decrypted = web3.eth.accounts.decrypt(JSON.parse(account.encrypted), password);
          } catch {
            throw new Error('Mật khẩu không đúng!');
          }

          const tx = {
            from: currentAccount,
            data: bytecode,
            gas: gasLimit,
            gasPrice: gasPrice,
            value: valueWei
          };

          const signedTx = await web3.eth.accounts.signTransaction(tx, decrypted.privateKey);
          receipt = await web3.eth.sendSignedTransaction(signedTx.rawTransaction);
          contractAddress = receipt.contractAddress;
        }

        const gasFeeWei = BigInt(gasPrice) * BigInt(receipt.gasUsed);
        const gasFeeEth = web3.utils.fromWei(gasFeeWei.toString(), 'ether');

        // Save deployed contract
        const contracts = JSON.parse(localStorage.getItem('deployedContracts') || '[]');
        contracts.unshift({
          address: contractAddress,
          deployer: currentAccount,
          transactionHash: receipt.transactionHash,
          blockNumber: receipt.blockNumber,
          gasUsed: receipt.gasUsed,
          gasFee: gasFeeEth,
          value: value,
          timestamp: new Date().toISOString()
        });
        localStorage.setItem('deployedContracts', JSON.stringify(contracts));

        logToBackend('CONTRACT_DEPLOYED', {
          contractAddress,
          deployer: currentAccount,
          transactionHash: receipt.transactionHash,
          blockNumber: receipt.blockNumber,
          gasUsed: receipt.gasUsed,
          timestamp: new Date().toISOString()
        });

        messageEl.innerHTML = `
          <div class="message success">
            ✅ Triển khai thành công!<br>
            <strong>Địa chỉ hợp đồng:</strong><br>
            <div style="font-family: 'Courier New', monospace; font-size: 13px; word-break: break-all; margin: 10px 0; padding: 10px; background: var(--table-header); border-radius: 8px;">
              ${contractAddress}
              <button class="copy-btn" onclick="copyToClipboard('${contractAddress}', this)" title="Copy address">📋</button>
            </div>
            <small>Hash: ${receipt.transactionHash}</small><br>
            <small>Gas sử dụng: ${receipt.gasUsed}</small>
          </div>
        `;

        document.getElementById('contractBytecode').value = '';
        document.getElementById('contractArgs').value = '';
        document.getElementById('contractValue').value = '';
        if (passwordInput) passwordInput.value = '';
        document.getElementById('contractGasFeeDisplay').innerHTML = '';

        renderDeployedContractsList();
        await loadBalance();

      } catch (err) {
        messageEl.innerHTML = `<div class="message error">❌ Lỗi: ${err.message}</div>`;
        
        logToBackend('CONTRACT_DEPLOY_FAILED', {
          deployer: currentAccount,
          error: err.message,
          timestamp: new Date().toISOString()
        });
      }
    }

    function renderDeployedContractsList() {
      const listEl = document.getElementById('deployedContractsList');
      if (!listEl) return;

      const contracts = JSON.parse(localStorage.getItem('deployedContracts') || '[]');
      const myContracts = contracts.filter(c => c.deployer.toLowerCase() === currentAccount.toLowerCase());

      if (myContracts.length === 0) {
        listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Chưa triển khai hợp đồng nào</p>';
        return;
      }

      listEl.innerHTML = `
        <div style="overflow-x: auto;">
          <table>
            <thead>
              <tr>
                <th>Địa chỉ Hợp đồng</th>
                <th>Block</th>
                <th>Gas Used</th>
                <th>Thời gian</th>
              </tr>
            </thead>
            <tbody>
              ${myContracts.map(contract => `
                <tr>
                  <td class="address">
                    ${contract.address.slice(0, 10)}...${contract.address.slice(-8)}
                    <button class="copy-btn" onclick="copyToClipboard('${contract.address}', this)" title="Copy address">📋</button>
                  </td>
                  <td>${contract.blockNumber}</td>
                  <td>${contract.gasUsed}</td>
                  <td style="font-size: 12px;">${new Date(contract.timestamp).toLocaleString('vi-VN')}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }
    
    async function calculateGasFee() {
      const to = document.getElementById('transferTo').value;
      const amount = document.getElementById('transferAmount').value;
      const displayEl = document.getElementById('gasFeeDisplay');

      if (!to || !amount || amount <= 0) {
        displayEl.innerHTML = '';
        return;
      }

      // Validate address first
      const validation = validateAddress(to);
      if (!validation.valid) {
        return;
      }

      try {
        const gasInfo = await estimateGasFee(currentAccount, to, amount);
        displayEl.innerHTML = `
          <div class="gas-fee-box">
            <div style="font-weight: bold; margin-bottom: 10px; color: var(--text-primary);">⛽ Chi phí giao dịch</div>
            <div class="gas-fee-row">
              <span>Gas Price:</span>
              <span>${Number.parseFloat(gasInfo.gasPrice).toFixed(2)} Gwei</span>
            </div>
            <div class="gas-fee-row">
              <span>Gas Limit:</span>
              <span>${gasInfo.gasLimit}</span>
            </div>
            <div class="gas-fee-row">
              <span>Gas Fee:</span>
              <span>${Number.parseFloat(gasInfo.gasFee).toFixed(6)} ETH</span>
            </div>
            <div class="gas-fee-row total">
              <span>Tổng cộng:</span>
              <span>${gasInfo.total} ETH</span>
            </div>
          </div>
        `;
      } catch (err) {
        displayEl.innerHTML = `<div class="message error">❌ ${err.message}</div>`;
      }
    }

    // ==================== AUTH HANDLERS ====================
    
    async function handleRegister() {
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const messageEl = document.getElementById('authMessage');

      if (password.length < 6) {
        messageEl.innerHTML = '<div class="message error">❌ Mật khẩu phải ≥ 6 ký tự</div>';
        return;
      }
      if (password !== confirmPassword) {
        messageEl.innerHTML = '<div class="message error">❌ Mật khẩu xác nhận không khớp</div>';
        return;
      }

      messageEl.innerHTML = '<div class="message info">⏳ Đang tạo tài khoản...</div>';

      try {
        const { address, encrypted } = await createAccount(password);
        
        const accounts = JSON.parse(localStorage.getItem('walletAccounts') || '[]');
        accounts.push({
          address,
          encrypted,
          createdAt: new Date().toISOString(),
          type: 'user'
        });
        localStorage.setItem('walletAccounts', JSON.stringify(accounts));

        messageEl.innerHTML = `<div class="message success">✅ Tạo tài khoản thành công!<br><small>${address}</small></div>`;
        
        setTimeout(() => {
          currentAccount = address;
          localStorage.setItem('currentAccount', address);
          currentPage = 'dashboard';
          render();
          loadBalance();
        }, 1500);
      } catch (err) {
        messageEl.innerHTML = `<div class="message error">❌ Lỗi: ${err.message}</div>`;
      }
    }

    async function handleImportDevAccount() {
      const messageEl = document.getElementById('authMessage');
      messageEl.innerHTML = '<div class="message info">⏳ Đang import dev account...</div>';

      try {
        const { address, balance } = await importDevAccount();
        
        const accounts = JSON.parse(localStorage.getItem('walletAccounts') || '[]');
        const existing = accounts.find(a => a.address.toLowerCase() === address.toLowerCase());
        
        if (existing) {
          messageEl.innerHTML = `<div class="message info">ℹ️ Dev account đã tồn tại!<br>🔑 ${address}<br>💰 Số dư: ${balance} ETH</div>`;
          
          setTimeout(() => {
            currentAccount = address;
            localStorage.setItem('currentAccount', address);
            currentPage = 'dashboard';
            render();
            loadBalance();
          }, 2000);
          return;
        }
        
        accounts.push({
          address,
          type: 'dev',
          createdAt: new Date().toISOString()
        });
        localStorage.setItem('walletAccounts', JSON.stringify(accounts));

        messageEl.innerHTML = `<div class="message success">✅ Import thành công!<br>🔑 ${address}<br>💰 Số dư: ${balance} ETH<br>🔓 Không cần mật khẩu (quản lý bởi Geth)</div>`;
        
        setTimeout(() => {
          currentAccount = address;
          localStorage.setItem('currentAccount', address);
          currentPage = 'dashboard';
          render();
          loadBalance();
        }, 2000);
      } catch (err) {
        messageEl.innerHTML = `<div class="message error">❌ Lỗi: ${err.message}</div>`;
      }
    }

    async function handleLogin() {
      const address = document.getElementById('loginAddress').value;
      const password = document.getElementById('loginPassword').value;
      const messageEl = document.getElementById('authMessage');

      if (!address || !password) {
        messageEl.innerHTML = '<div class="message error">❌ Vui lòng nhập đầy đủ thông tin</div>';
        return;
      }

      messageEl.innerHTML = '<div class="message info">⏳ Đang đăng nhập...</div>';

      try {
        const accounts = JSON.parse(localStorage.getItem('walletAccounts') || '[]');
        const account = accounts.find(a => a.address.toLowerCase() === address.toLowerCase());
        
        if (!account) {
          messageEl.innerHTML = '<div class="message error">❌ Tài khoản không tồn tại</div>';
          return;
        }

        if (account.type !== 'dev') {
          web3.eth.accounts.decrypt(JSON.parse(account.encrypted), password);
        }
        
        logToBackend('LOGIN_SUCCESS', { address });
        messageEl.innerHTML = '<div class="message success">✅ Đăng nhập thành công!</div>';
        
        setTimeout(() => {
          currentAccount = address;
          localStorage.setItem('currentAccount', address);
          currentPage = 'dashboard';
          render();
          loadBalance();
        }, 1000);
      } catch (err) {
        messageEl.innerHTML = '<div class="message error">❌ Sai mật khẩu!</div>';
        logToBackend('LOGIN_FAILED', { address, error: err.message });
      }
    }

    function handleLogout() {
      if (confirm('Bạn có chắc chắn muốn đăng xuất?')) {
        currentAccount = null;
        localStorage.removeItem('currentAccount');
        currentPage = 'login';
        render();
      }
    }

    async function loadBalance() {
      if (!currentAccount) return;
      
      try {
        const restored = await restoreBalanceIfNeeded(currentAccount);
        if (restored) {
          await new Promise(resolve => setTimeout(resolve, 2000));
        }
        
        const balance = await getBalance(currentAccount);
        const formattedBalance = Number.parseFloat(balance).toFixed(6);
        
        currentBalanceValue = formattedBalance;
        
        const balanceEl = document.getElementById('currentBalance');
        if (balanceEl) {
          if (balanceVisible) {
            balanceEl.textContent = formattedBalance + ' ETH';
            balanceEl.classList.remove('balance-hidden');
          } else {
            balanceEl.textContent = '••••••';
            balanceEl.classList.add('balance-hidden');
          }
        }
        
        saveCurrentBalance(currentAccount, balance);
        saveBalanceHistory(currentAccount, balance);
      } catch (err) {
        console.error('Lỗi load balance:', err);
      }
    }

    async function handleTransfer() {
      const to = document.getElementById('transferTo').value.trim();
      const amount = document.getElementById('transferAmount').value;
      const passwordInput = document.getElementById('transferPassword');
      const password = passwordInput ? passwordInput.value : '';
      const messageEl = document.getElementById('transferMessage');

      const accounts = JSON.parse(localStorage.getItem('walletAccounts') || '[]');
      const currentAcc = accounts.find(a => a.address.toLowerCase() === currentAccount.toLowerCase());
      const isDevAccount = currentAcc && currentAcc.type === 'dev';

      if (!to || !amount) {
        messageEl.innerHTML = '<div class="message error">❌ Vui lòng nhập đầy đủ thông tin</div>';
        return;
      }

      const validation = validateAddress(to);
      if (!validation.valid) {
        messageEl.innerHTML = `<div class="message error">${validation.message}</div>`;
        return;
      }

      const warnings = checkPhishingPattern(to);
      if (warnings.length > 0) {
        const confirmed = confirm('⚠️ CẢNH BÁO BẢO MẬT!\n\n' + warnings.join('\n') + '\n\nBạn có chắc chắn muốn tiếp tục?');
        if (!confirmed) {
          messageEl.innerHTML = '<div class="message warning">🛡️ Giao dịch đã bị hủy vì lý do bảo mật</div>';
          return;
        }
      }

      if (!isDevAccount && !password) {
        messageEl.innerHTML = '<div class="message error">❌ Vui lòng nhập mật khẩu</div>';
        return;
      }

      const checksumTo = web3.utils.toChecksumAddress(to);
      const confirmMsg = `🔍 XÁC NHẬN GIAO DỊCH\n\n` +
        `Từ: ${currentAccount}\n` +
        `Đến: ${checksumTo}\n` +
        `Số tiền: ${amount} ETH\n\n` +
        `Bạn có chắc chắn muốn thực hiện giao dịch này?`;
      
      if (!confirm(confirmMsg)) {
        messageEl.innerHTML = '<div class="message info">❌ Giao dịch đã bị hủy</div>';
        return;
      }

      messageEl.innerHTML = '<div class="message info">⏳ Đang gửi giao dịch...</div>';

      try {
        const receipt = await sendTransaction(currentAccount, checksumTo, amount, password);
        
        const history = JSON.parse(localStorage.getItem('txHistory') || '[]');
        history.unshift({
          hash: receipt.transactionHash,
          from: currentAccount,
          to: checksumTo,
          value: amount,
          blockNumber: receipt.blockNumber,
          gasFee: receipt.gasFee,
          gasPrice: receipt.gasPrice,
          status: receipt.status ? 'success' : 'failed',
          timestamp: new Date().toISOString()
        });
        localStorage.setItem('txHistory', JSON.stringify(history));

        const txJson = JSON.stringify(history[0]).replaceAll("'", "&#39;").replaceAll('"', "&quot;");
        messageEl.innerHTML = `
          <div class="message success">
            ✅ Thành công!<br>
            <small>Hash: ${receipt.transactionHash}</small><br>
            <div class="security-badge verified" style="display: inline-flex; margin-top: 10px;">
              🔒 Giao dịch đã được xác thực và ghi vào blockchain
            </div><br>
            <button onclick='showTransactionDetail(${txJson})' 
                    style="margin-top: 10px; width: auto; padding: 8px 16px;">
              📋 Xem chi tiết
            </button>
          </div>
        `;
        
        document.getElementById('transferTo').value = '';
        document.getElementById('transferAmount').value = '';
        if (passwordInput) passwordInput.value = '';
        document.getElementById('gasFeeDisplay').innerHTML = '';
        document.getElementById('addressValidation').innerHTML = '';
        showPhishingWarning([]);
        
        await loadBalance();
        
        if (localStorage.getItem('dashboardTab') === 'chart') {
          setTimeout(() => refreshChart(), 1000);
        }
      } catch (err) {
        messageEl.innerHTML = `<div class="message error">❌ Lỗi: ${err.message}</div>`;
        
        logToBackend('TRANSACTION_FAILED', {
          from: currentAccount,
          to: checksumTo,
          amount: amount,
          error: err.message,
          timestamp: new Date().toISOString()
        });
      }
    }

    // ==================== INITIALIZATION ====================
    
    void async function() {
      initTheme();
      
      const connected = await initWeb3();
      
      if (!connected) {
        document.getElementById('app').innerHTML = `
          <div class="card" style="max-width: 600px; margin: 50px auto; text-align: center;">
            <h1 style="color: #DC2626;">❌ Không thể kết nối Geth</h1>
            <p style="margin: 20px 0;">Vui lòng kiểm tra:</p>
            <ul style="text-align: left; padding-left: 40px;">
              <li>Geth đã chạy: <code>geth --dev --http --http.api eth,net,web3 --http.corsdomain "*"</code></li>
              <li>RPC đang lắng nghe tại: <code>http://127.0.0.1:8545</code></li>
              <li>CORS được bật</li>
            </ul>
            <button onclick="location.reload()">🔄 Thử lại</button>
          </div>
        `;
        return;
      }

      const savedAccount = localStorage.getItem('currentAccount');
      if (savedAccount) {
        currentAccount = savedAccount;
        currentPage = 'dashboard';
      }

      render();
      
      if (currentPage === 'dashboard') {
        await loadBalance();
        const savedTab = localStorage.getItem('dashboardTab');
        if (!savedTab || savedTab === 'balance' || savedTab === 'history') {
          switchTab('chart');
        } else {
          switchTab(savedTab);
          if (savedTab === 'contract') {
            setTimeout(() => renderDeployedContractsList(), 100);
          }
        }
        setInterval(loadBalance, 10000);
      }
    }();
  </script>
</body>
</html>