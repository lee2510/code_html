<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Geth Wallet Manager - Secure</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    :root {
      --bg-primary: linear-gradient(135deg, #4B5EAA 0%, #6B7280 100%);
      --bg-card: #FFFFFF;
      --bg-input: #FFFFFF;
      --text-primary: #1F2937;
      --text-secondary: #6B7280;
      --border-color: #D1D5DB;
      --button-primary: linear-gradient(135deg, #4B5EAA 0%, #6366F1 100%);
      --button-secondary: #E5E7EB;
      --success-bg: #D1FAE5;
      --success-text: #065F46;
      --success-border: #0D9488;
      --error-bg: #FEE2E2;
      --error-text: #991B1B;
      --error-border: #DC2626;
      --warning-bg: #FEF3C7;
      --warning-text: #92400E;
      --warning-border: #F59E0B;
      --table-header: #F3F4F6;
      --table-border: #E5E7EB;
      --table-hover: #F9FAFB;
      --shadow: rgba(0,0,0,0.1);
    }

    [data-theme="dark"] {
      --bg-primary: linear-gradient(135deg, #1F2937 0%, #111827 100%);
      --bg-card: #1F2937;
      --bg-input: #374151;
      --text-primary: #F9FAFB;
      --text-secondary: #D1D5DB;
      --border-color: #4B5563;
      --button-primary: linear-gradient(135deg, #6366F1 0%, #4F46E5 100%);
      --button-secondary: #374151;
      --success-bg: #064E3B;
      --success-text: #D1FAE5;
      --success-border: #0D9488;
      --error-bg: #7F1D1D;
      --error-text: #FEE2E2;
      --error-border: #DC2626;
      --warning-bg: #78350F;
      --warning-text: #FEF3C7;
      --warning-border: #F59E0B;
      --table-header: #374151;
      --table-border: #4B5563;
      --table-hover: #2D3748;
      --shadow: rgba(0,0,0,0.3);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      min-height: 100vh;
      padding: 20px;
      color: var(--text-primary);
      transition: background 0.3s, color 0.3s;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    .card { 
      background: var(--bg-card); 
      border-radius: 16px; 
      padding: 30px; 
      margin-bottom: 20px;
      box-shadow: 0 10px 30px var(--shadow);
      transition: background 0.3s;
    }
    input, button, select { 
      width: 100%; 
      padding: 12px 16px; 
      border-radius: 8px; 
      border: 2px solid var(--border-color);
      font-size: 14px;
      margin-bottom: 12px;
      transition: all 0.3s;
      background: var(--bg-input);
      color: var(--text-primary);
    }
    input:focus { border-color: #6366F1; outline: none; }
    button { 
      background: var(--button-primary);
      color: #FFFFFF; 
      border: none; 
      cursor: pointer;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(75,94,170,0.3); }
    button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    button.secondary { background: var(--button-secondary); color: var(--text-primary); }
    button.danger { background: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%); }
    button.success { background: linear-gradient(135deg, #0D9488 0%, #047857 100%); }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .tab { 
      flex: 1; 
      min-width: 120px;
      padding: 14px 20px; 
      background: var(--button-secondary); 
      border: none; 
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      color: var(--text-primary);
      transition: all 0.3s;
    }
    .tab.active { 
      background: var(--button-primary);
      color: #FFFFFF;
      box-shadow: 0 5px 15px rgba(75,94,170,0.3);
    }
    .message { 
      padding: 15px; 
      border-radius: 10px; 
      margin-top: 15px;
      animation: slideIn 0.3s;
    }
    @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .message.success { background: var(--success-bg); color: var(--success-text); border-left: 4px solid var(--success-border); }
    .message.error { background: var(--error-bg); color: var(--error-text); border-left: 4px solid var(--error-border); }
    .message.info { background: var(--warning-bg); color: var(--warning-text); border-left: 4px solid var(--warning-border); }
    .message.warning { background: #FEF3C7; color: #92400E; border-left: 4px solid #F59E0B; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th { background: var(--table-header); padding: 12px; text-align: left; font-weight: 600; color: var(--text-primary); }
    td { padding: 12px; border-bottom: 1px solid var(--table-border); font-size: 13px; color: var(--text-secondary); }
    tr:hover { background: var(--table-hover); }
    .header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 10px;
      flex-wrap: wrap;
      gap: 15px;
    }
    .balance-display { 
      font-size: 32px; 
      font-weight: bold; 
      color: #4B5EAA;
      text-shadow: 1px 1px 2px var(--shadow);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    [data-theme="dark"] .balance-display {
      color: #6366F1;
    }
    .balance-toggle {
      background: var(--button-secondary);
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      padding: 0;
      margin: 0;
      color: var(--text-primary);
    }
    .balance-toggle:hover {
      background: var(--border-color);
      transform: scale(1.05);
    }
    .balance-hidden {
      letter-spacing: 4px;
      font-size: 28px;
    }
    .address { 
      font-family: 'Courier New', monospace; 
      font-size: 12px; 
      color: var(--text-secondary);
      word-break: break-all;
    }
    .log-entry { 
      background: var(--table-header); 
      padding: 12px; 
      margin-bottom: 8px; 
      border-radius: 8px;
      border-left: 4px solid #6366F1;
    }
    .log-header { 
      display: flex; 
      justify-content: space-between; 
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-primary);
    }
    .log-data { 
      font-size: 12px; 
      color: var(--text-secondary); 
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: bold;
    }
    .status-success { background: #0D9488; color: #FFFFFF; }
    .status-failed { background: #DC2626; color: #FFFFFF; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      animation: fadeIn 0.3s;
    }
    .modal.show { display: flex; align-items: center; justify-content: center; }
    .modal-content {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      animation: slideUp 0.3s;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--border-color);
    }
    .modal-close {
      background: var(--button-secondary);
      border: none;
      width: 35px;
      height: 35px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      line-height: 1;
      margin: 0;
      color: var(--text-primary);
    }
    .modal-close:hover { background: var(--border-color); transform: none; }
    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--table-border);
    }
    .detail-label { color: var(--text-secondary); font-weight: 600; }
    .detail-value { color: var(--text-primary); font-weight: 500; text-align: right; word-break: break-all; }
    .search-box {
      position: relative;
      margin-bottom: 15px;
    }
    .search-box input {
      padding-right: 100px;
    }
    .search-box button {
      position: absolute;
      right: 5px;
      top: 5px;
      width: auto;
      padding: 8px 15px;
      margin: 0;
    }
    .gas-fee-box {
      background: var(--table-header);
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }
    .gas-fee-row {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      font-size: 14px;
    }
    .gas-fee-row.total {
      font-weight: bold;
      font-size: 16px;
      color: #4B5EAA;
      padding-top: 10px;
      margin-top: 10px;
      border-top: 2px solid var(--border-color);
    }
    [data-theme="dark"] .gas-fee-row.total {
      color: #6366F1;
    }
    .copy-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #6366F1;
      color: white;
      border: none;
      width: 28px;
      height: 28px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-left: 8px;
      transition: all 0.3s;
      padding: 0;
    }
    .copy-btn:hover {
      background: #4F46E5;
      transform: scale(1.1);
    }
    .copy-btn.copied {
      background: #0D9488;
    }
    .chart-container {
      position: relative;
      height: 300px;
      margin-top: 20px;
    }
    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--bg-card);
      border: 2px solid var(--border-color);
      cursor: pointer;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      z-index: 999;
      box-shadow: 0 4px 12px var(--shadow);
    }
    .theme-toggle:hover {
      transform: rotate(180deg) scale(1.1);
    }
    .security-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      margin-top: 10px;
    }
    .security-badge.verified {
      background: #D1FAE5;
      color: #065F46;
      border: 1px solid #0D9488;
    }
    .security-badge.warning {
      background: #FEF3C7;
      color: #92400E;
      border: 1px solid #F59E0B;
    }
    .security-badge.danger {
      background: #FEE2E2;
      color: #991B1B;
      border: 1px solid #DC2626;
    }
    [data-theme="dark"] .security-badge.verified {
      background: #064E3B;
      color: #D1FAE5;
    }
    [data-theme="dark"] .security-badge.warning {
      background: #78350F;
      color: #FEF3C7;
    }
    [data-theme="dark"] .security-badge.danger {
      background: #7F1D1D;
      color: #FEE2E2;
    }
    .phishing-warning {
      background: #FEF3C7;
      border: 2px solid #F59E0B;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      display: none;
    }
    [data-theme="dark"] .phishing-warning {
      background: #78350F;
      border-color: #F59E0B;
    }
    .phishing-warning.show {
      display: block;
      animation: shake 0.5s;
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }
    .address-validation {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: -10px;
      margin-bottom: 10px;
      font-size: 12px;
    }
    .validation-icon {
      font-size: 16px;
    }
    @media (max-width: 768px) {
      .grid-2 { grid-template-columns: 1fr; }
      .header { flex-direction: column; text-align: center; }
      .theme-toggle { top: 10px; right: 10px; width: 45px; height: 45px; }
    }
    h1, h2 { margin-bottom: 15px; color: var(--text-primary); }
    h1 { font-size: 28px; }
    h2 { font-size: 20px; }
    .loading { text-align: center; padding: 40px; color: var(--text-primary); font-size: 18px; }
  </style>
</head>
<body>
  <!-- Theme Toggle Button -->
  <button class="theme-toggle" onclick="toggleTheme()" title="Chuy·ªÉn ƒë·ªïi ch·∫ø ƒë·ªô s√°ng/t·ªëi">
    <span id="themeIcon">üåô</span>
  </button>

  <div id="app" class="container">
    <div class="loading">‚è≥ ƒêang kh·ªüi t·∫°o v√≠...</div>
  </div>

  <!-- Modal chi ti·∫øt giao d·ªãch -->
  <div id="txDetailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üìã Chi ti·∫øt giao d·ªãch</h2>
        <button class="modal-close" onclick="closeModal()">‚úï</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <script>
    const GETH_RPC = 'http://127.0.0.1:8545';
    let web3;
    let currentAccount = null;
    let currentPage = 'login';
    let balanceVisible = true;
    let currentBalanceValue = '0.000000';

    // ==================== THEME MANAGEMENT ====================
    
    function initTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      const root = document.documentElement;
      root.dataset.theme = savedTheme;
      updateThemeIcon(savedTheme);
    }

    function toggleTheme() {
      const root = document.documentElement;
      const currentTheme = root.dataset.theme || 'light';
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      root.dataset.theme = newTheme;
      localStorage.setItem('theme', newTheme);
      updateThemeIcon(newTheme);
      
      // Re-render chart if visible
      if (currentPage === 'dashboard' && localStorage.getItem('dashboardTab') === 'chart') {
        setTimeout(() => renderBalanceChart(), 100);
      }
    }

    function updateThemeIcon(theme) {
      const icon = document.getElementById('themeIcon');
      if (icon) {
        icon.textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
      }
    }

    // ==================== SECURITY FUNCTIONS ====================
    
    // Danh s√°ch ƒëen ƒë·ªãa ch·ªâ phishing (m·∫´u - c√≥ th·ªÉ m·ªü r·ªông)
    const BLACKLIST_ADDRESSES = new Set([
      '0x0000000000000000000000000000000000000000',
      '0xdead000000000000000000000000000000000000'
    ]);

    // Ki·ªÉm tra ƒë·ªãa ch·ªâ c√≥ h·ª£p l·ªá kh√¥ng
    function validateAddress(address) {
      if (!address) {
        return { valid: false, message: '‚ùå ƒê·ªãa ch·ªâ kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng' };
      }

      // Ki·ªÉm tra format c∆° b·∫£n
      if (!/^0x[a-fA-F0-9]{40}$/.test(address)) {
        return { valid: false, message: '‚ùå ƒê·ªãa ch·ªâ kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng (0x + 40 k√Ω t·ª± hex)' };
      }

      // Ki·ªÉm tra blacklist
      if (BLACKLIST_ADDRESSES.has(address.toLowerCase())) {
        return { valid: false, message: '‚ö†Ô∏è C·∫¢NH B√ÅO: ƒê·ªãa ch·ªâ n√†y n·∫±m trong danh s√°ch ƒëen!' };
      }

      // Ki·ªÉm tra checksum
      try {
        const checksumAddress = web3.utils.toChecksumAddress(address);
        
        // N·∫øu ƒë·ªãa ch·ªâ c√≥ ch·ªØ hoa/th∆∞·ªùng h·ªón h·ª£p nh∆∞ng kh√¥ng kh·ªõp checksum
        if (address !== address.toLowerCase() && address !== address.toUpperCase()) {
          if (address !== checksumAddress) {
            return { 
              valid: false, 
              message: '‚ö†Ô∏è Checksum kh√¥ng h·ª£p l·ªá! ƒê·ªãa ch·ªâ c√≥ th·ªÉ ƒë√£ b·ªã s·ª≠a ƒë·ªïi.',
              corrected: checksumAddress
            };
          }
        }

        return { valid: true, message: '‚úÖ ƒê·ªãa ch·ªâ h·ª£p l·ªá', checksumAddress };
      } catch (err) {
        return { valid: false, message: '‚ùå ƒê·ªãa ch·ªâ kh√¥ng h·ª£p l·ªá: ' + err.message };
      }
    }

    // Ki·ªÉm tra phishing d·ª±a tr√™n pattern
    function checkPhishingPattern(address) {
      const warnings = [];

      // Ki·ªÉm tra ƒë·ªãa ch·ªâ null
      if (address.toLowerCase() === '0x0000000000000000000000000000000000000000') {
        warnings.push('üö® ƒê·ªãa ch·ªâ NULL - ti·ªÅn s·∫Ω b·ªã m·∫•t vƒ©nh vi·ªÖn!');
      }

      // Ki·ªÉm tra nhi·ªÅu s·ªë 0 li√™n ti·∫øp (c√≥ th·ªÉ l√† typo)
      if (/0{8,}/.test(address)) {
        warnings.push('‚ö†Ô∏è ƒê·ªãa ch·ªâ ch·ª©a nhi·ªÅu s·ªë 0 li√™n ti·∫øp - ki·ªÉm tra k·ªπ!');
      }

      // Ki·ªÉm tra pattern l·∫∑p l·∫°i ƒë√°ng ng·ªù
      if (/(.)\1{10,}/.test(address)) {
        warnings.push('‚ö†Ô∏è ƒê·ªãa ch·ªâ c√≥ k√Ω t·ª± l·∫∑p l·∫°i b·∫•t th∆∞·ªùng!');
      }

      return warnings;
    }

    // Hi·ªÉn th·ªã c·∫£nh b√°o phishing
    function showPhishingWarning(warnings) {
      const warningDiv = document.getElementById('phishingWarning');
      if (!warningDiv) return;

      if (warnings.length > 0) {
        warningDiv.innerHTML = `
          <div style="display: flex; align-items: start; gap: 10px;">
            <div style="font-size: 24px;">‚ö†Ô∏è</div>
            <div>
              <div style="font-weight: bold; margin-bottom: 5px;">C·∫¢NH B√ÅO B·∫¢O M·∫¨T</div>
              ${warnings.map(w => `<div style="margin: 5px 0;">‚Ä¢ ${w}</div>`).join('')}
            </div>
          </div>
        `;
        warningDiv.classList.add('show');
      } else {
        warningDiv.classList.remove('show');
      }
    }

    // ==================== STORAGE FUNCTIONS ====================
    
    function saveBalanceHistory(address, balance) {
      const historyKey = `balanceHistory_${address}`;
      let history = JSON.parse(localStorage.getItem(historyKey) || '[]');
      
      const now = new Date().toISOString();
      const lastEntry = history.at(-1);
      
      if (!lastEntry || 
          lastEntry.balance !== balance || 
          (new Date(now) - new Date(lastEntry.timestamp)) > 60000) {
        history.push({
          balance: Number.parseFloat(balance),
          timestamp: now
        });
        
        if (history.length > 100) {
          history = history.slice(-100);
        }
        
        localStorage.setItem(historyKey, JSON.stringify(history));
      }
    }

    function getBalanceHistory(address) {
      const historyKey = `balanceHistory_${address}`;
      return JSON.parse(localStorage.getItem(historyKey) || '[]');
    }

    function saveCurrentBalance(address, balance) {
      const balanceKey = `savedBalance_${address}`;
      localStorage.setItem(balanceKey, balance);
    }

    function getSavedBalance(address) {
      const balanceKey = `savedBalance_${address}`;
      return localStorage.getItem(balanceKey);
    }

    async function restoreBalanceIfNeeded(address) {
      try {
        const currentBalance = await getBalance(address);
        const savedBalance = getSavedBalance(address);
        
        if (savedBalance && Number.parseFloat(savedBalance) > 0 && Number.parseFloat(currentBalance) === 0) {
          console.log(`üîÑ Ph√°t hi·ªán s·ªë d∆∞ b·ªã reset. ƒêang kh√¥i ph·ª•c ${savedBalance} ETH...`);
          
          const accounts = await web3.eth.getAccounts();
          if (accounts && accounts.length > 0) {
            const devAddress = accounts[0];
            
            await web3.eth.sendTransaction({
              from: devAddress,
              to: address,
              value: web3.utils.toWei(savedBalance, 'ether'),
              gas: 21000
            });
            
            console.log(`‚úÖ ƒê√£ kh√¥i ph·ª•c ${savedBalance} ETH cho ${address}`);
            
            logToBackend('BALANCE_RESTORED', {
              address: address,
              amount: savedBalance + ' ETH',
              timestamp: new Date().toISOString()
            });
            
            return true;
          }
        }
        
        return false;
      } catch (err) {
        console.error('L·ªói kh√¥i ph·ª•c s·ªë d∆∞:', err);
        return false;
      }
    }

    // ==================== WEB3 FUNCTIONS ====================
    
    async function initWeb3() {
      try {
        web3 = new Web3(new Web3.providers.HttpProvider(GETH_RPC));
        const networkId = await web3.eth.net.getId();
        console.log('‚úÖ K·∫øt n·ªëi Geth th√†nh c√¥ng - Network ID:', networkId);
        return true;
      } catch (err) {
        console.error('‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi Geth:', err);
        return false;
      }
    }

    function logToBackend(event, data) {
      const logs = JSON.parse(localStorage.getItem('gethLogs') || '[]');
      logs.unshift({
        event,
        data,
        timestamp: new Date().toISOString()
      });
      localStorage.setItem('gethLogs', JSON.stringify(logs.slice(0, 100)));
      console.log(`[GETH LOG] ${event}:`, data);
    }

    async function createAccount(password) {
      try {
        const account = web3.eth.accounts.create();
        const encrypted = web3.eth.accounts.encrypt(account.privateKey, password);
        
        logToBackend('ACCOUNT_CREATED', {
          address: account.address,
          timestamp: new Date().toISOString()
        });

        return { address: account.address, encrypted: JSON.stringify(encrypted) };
      } catch (err) {
        throw new Error('Kh√¥ng th·ªÉ t·∫°o t√†i kho·∫£n: ' + err.message);
      }
    }

    async function importDevAccount() {
      try {
        const accounts = await web3.eth.getAccounts();
        if (!accounts || accounts.length === 0) {
          throw new Error('Kh√¥ng c√≥ account Geth! Ch·∫°y: geth --dev --http --http.api eth,net,web3,personal');
        }

        const devAddress = accounts[0];
        const balance = await web3.eth.getBalance(devAddress);
        
        logToBackend('DEV_ACCOUNT_IMPORTED', {
          address: devAddress,
          balance: web3.utils.fromWei(balance, 'ether') + ' ETH',
          timestamp: new Date().toISOString()
        });

        return {
          address: devAddress,
          balance: web3.utils.fromWei(balance, 'ether'),
          type: 'dev'
        };
      } catch (err) {
        throw new Error('L·ªói import dev account: ' + err.message);
      }
    }

    async function getBalance(address) {
      try {
        const balance = await web3.eth.getBalance(address);
        return web3.utils.fromWei(balance, 'ether');
      } catch (err) {
        throw new Error('Kh√¥ng th·ªÉ l·∫•y s·ªë d∆∞: ' + err.message);
      }
    }

    async function estimateGasFee(fromAddress, toAddress, amount) {
      try {
        const gasPrice = await web3.eth.getGasPrice();
        const gasLimit = 21000;
        const gasFeeWei = BigInt(gasPrice) * BigInt(gasLimit);
        const gasFeeEth = web3.utils.fromWei(gasFeeWei.toString(), 'ether');
        
        return {
          gasPrice: web3.utils.fromWei(gasPrice, 'gwei'),
          gasLimit,
          gasFee: gasFeeEth,
          total: (Number.parseFloat(amount) + Number.parseFloat(gasFeeEth)).toFixed(6)
        };
      } catch (err) {
        throw new Error('Kh√¥ng th·ªÉ t√≠nh gas fee: ' + err.message);
      }
    }

    async function sendTransaction(fromAddress, toAddress, amount, password) {
      try {
        const accounts = JSON.parse(localStorage.getItem('walletAccounts') || '[]');
        const account = accounts.find(a => a.address.toLowerCase() === fromAddress.toLowerCase());
        
        if (!account) throw new Error('Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n!');

        const valueWei = web3.utils.toWei(amount.toString(), 'ether');
        const balance = await web3.eth.getBalance(fromAddress);
        const gasPrice = await web3.eth.getGasPrice();
        const gasLimit = 21000;
        const gasFeeWei = BigInt(gasPrice) * BigInt(gasLimit);
        const totalWei = BigInt(valueWei) + gasFeeWei;
        
        if (BigInt(balance) < totalWei) {
          throw new Error(`S·ªë d∆∞ kh√¥ng ƒë·ªß (c·∫ßn ${web3.utils.fromWei(totalWei.toString(), 'ether')} ETH, c√≥ ${web3.utils.fromWei(balance, 'ether')} ETH)`);
        }

        let receipt;

        if (account.type === 'dev') {
          const tx = {
            from: fromAddress,
            to: toAddress,
            value: valueWei,
            gas: gasLimit,
            gasPrice: gasPrice
          };

          receipt = await web3.eth.sendTransaction(tx);
        } else {
          let decrypted;
          try {
            decrypted = web3.eth.accounts.decrypt(JSON.parse(account.encrypted), password);
          } catch {
            throw new Error('M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!');
          }

          const tx = {
            from: fromAddress,
            to: toAddress,
            value: valueWei,
            gas: gasLimit,
            gasPrice: gasPrice
          };

          const signedTx = await web3.eth.accounts.signTransaction(tx, decrypted.privateKey);
          receipt = await web3.eth.sendSignedTransaction(signedTx.rawTransaction);
        }

        logToBackend('TRANSACTION_SENT', {
          hash: receipt.transactionHash,
          from: fromAddress,
          to: toAddress,
          value: amount,
          gasUsed: receipt.gasUsed,
          gasPrice: web3.utils.fromWei(gasPrice, 'gwei'),
          blockNumber: receipt.blockNumber,
          timestamp: new Date().toISOString()
        });

        return {
          ...receipt,
          gasFee: web3.utils.fromWei(gasFeeWei.toString(), 'ether'),
          gasPrice: web3.utils.fromWei(gasPrice, 'gwei')
        };
      } catch (err) {
        throw new Error('L·ªói g·ª≠i giao d·ªãch: ' + err.message);
      }
    }

    // ==================== UI RENDERING ====================
    
    function render() {
      const app = document.getElementById('app');
      
      if (currentPage === 'login') {
        app.innerHTML = renderLoginPage();
      } else if (currentPage === 'dashboard') {
        app.innerHTML = renderDashboard();
      }
    }

    function renderLoginPage() {
      const mode = localStorage.getItem('authMode') || 'login';
      
      return `
        <div class="card" style="max-width: 500px; margin: 50px auto;">
          <h1 style="text-align: center;">üîê V√≠ Blockchain</h1>
          <p style="text-align: center; color: var(--text-secondary); margin-bottom: 25px;">
            ${mode === 'login' ? 'ƒêƒÉng nh·∫≠p t√†i kho·∫£n' : 'T·∫°o t√†i kho·∫£n m·ªõi'}
          </p>

          <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button class="tab ${mode === 'login' ? 'active' : ''}" onclick="switchAuthMode('login')">
              üîì ƒêƒÉng nh·∫≠p
            </button>
            <button class="tab ${mode === 'register' ? 'active' : ''}" onclick="switchAuthMode('register')">
              üìù ƒêƒÉng k√Ω
            </button>
          </div>

          ${mode === 'register' ? `
            <div>
              <input type="password" id="password" placeholder="M·∫≠t kh·∫©u (‚â• 6 k√Ω t·ª±)" />
              <input type="password" id="confirmPassword" placeholder="X√°c nh·∫≠n m·∫≠t kh·∫©u" />
              <button onclick="handleRegister()">‚ú® T·∫°o t√†i kho·∫£n</button>
              <div style="text-align: center; margin: 10px 0; color: var(--text-secondary);">ho·∫∑c</div>
              <button class="success" onclick="handleImportDevAccount()">üî• Import Dev Account</button>
            </div>
          ` : `
            <div>
              <input type="text" id="loginAddress" placeholder="ƒê·ªãa ch·ªâ v√≠ (0x...)" />
              <input type="password" id="loginPassword" placeholder="M·∫≠t kh·∫©u" />
              <button onclick="handleLogin()">üöÄ ƒêƒÉng nh·∫≠p</button>
            </div>
          `}

          <div id="authMessage"></div>
        </div>
      `;
    }

    function renderDashboard() {
      const activeTab = localStorage.getItem('dashboardTab') || 'balance';
      
      return `
        <div class="card">
          <div class="header">
            <div>
              <h1>üíº V√≠ c·ªßa b·∫°n</h1>
              <div class="address" style="display: flex; align-items: center;">
                <span>${currentAccount}</span>
                <button class="copy-btn" onclick="copyToClipboard('${currentAccount}', this)" title="Copy address">
                  üìã
                </button>
              </div>
              <div class="security-badge verified">
                ‚úÖ ƒê·ªãa ch·ªâ ƒë√£ x√°c th·ª±c checksum
              </div>
            </div>
            <div style="text-align: right;">
              <div class="balance-display">
                <button class="balance-toggle" onclick="toggleBalanceVisibility()" title="·∫®n/Hi·ªán s·ªë d∆∞">
                  üëÅÔ∏è
                </button>
                <span id="currentBalance">0.000000 ETH</span>
              </div>
              <button class="danger" onclick="handleLogout()" style="width: auto; margin-top: 10px;">
                üö™ ƒêƒÉng xu·∫•t
              </button>
            </div>
          </div>
        </div>

        <div class="tabs">
          <button class="tab ${activeTab === 'balance' ? 'active' : ''}" onclick="switchTab('balance')">
            üí∞ S·ªë d∆∞
          </button>
          <button class="tab ${activeTab === 'chart' ? 'active' : ''}" onclick="switchTab('chart')">
            üìà Bi·ªÉu ƒë·ªì
          </button>
          <button class="tab ${activeTab === 'transfer' ? 'active' : ''}" onclick="switchTab('transfer')">
            üí∏ Chuy·ªÉn ti·ªÅn
          </button>
          <button class="tab ${activeTab === 'history' ? 'active' : ''}" onclick="switchTab('history')">
            üìú L·ªãch s·ª≠
          </button>
          <button class="tab ${activeTab === 'logs' ? 'active' : ''}" onclick="switchTab('logs')">
            üìä Logs
          </button>
        </div>

        <div class="card" id="tabContent"></div>
      `;
    }

    function renderBalanceTab() {
      return `
        <h2>üí∞ Ki·ªÉm tra s·ªë d∆∞</h2>
        <input type="text" id="checkAddress" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ v√≠" value="${currentAccount}" />
        <button onclick="checkBalance()">üîç Ki·ªÉm tra</button>
        <div id="balanceResult"></div>
      `;
    }

    function renderChartTab() {
      return `
        <h2>üìà Bi·ªÉu ƒë·ªì s·ªë d∆∞ theo th·ªùi gian</h2>
        <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 15px;">
          Theo d√µi s·ª± thay ƒë·ªïi s·ªë d∆∞ c·ªßa v√≠ ${currentAccount.slice(0, 10)}...
        </p>
        <div id="chartLoadingMessage"></div>
        <div class="chart-container">
          <canvas id="balanceChart"></canvas>
        </div>
        <div style="margin-top: 20px; text-align: center;">
          <button onclick="refreshChart()" style="width: auto; padding: 10px 20px;">
            üîÑ L√†m m·ªõi bi·ªÉu ƒë·ªì
          </button>
          <button onclick="clearChartHistory()" style="width: auto; padding: 10px 20px; margin-left: 10px;" class="danger">
            üóëÔ∏è X√≥a l·ªãch s·ª≠
          </button>
        </div>
      `;
    }

    function renderTransferTab() {
      const accounts = JSON.parse(localStorage.getItem('walletAccounts') || '[]');
      const currentAcc = accounts.find(a => a.address.toLowerCase() === currentAccount.toLowerCase());
      const isDevAccount = currentAcc && currentAcc.type === 'dev';
      
      return `
        <h2>üí∏ Chuy·ªÉn ti·ªÅn</h2>
        ${isDevAccount ? '<p style="color: #0D9488; font-size: 13px; margin-bottom: 10px;">üî• Dev Account - Kh√¥ng c·∫ßn m·∫≠t kh·∫©u</p>' : ''}
        <input type="text" value="${currentAccount}" disabled />
        <input type="text" id="transferTo" placeholder="ƒê·ªãa ch·ªâ nh·∫≠n (0x...)" oninput="validateTransferAddress()" />
        
        <div id="addressValidation" class="address-validation"></div>
        <div id="phishingWarning" class="phishing-warning"></div>
        
        <input type="number" id="transferAmount" placeholder="S·ªë ETH" step="0.001" oninput="calculateGasFee()" />
        
        <div id="gasFeeDisplay"></div>
        
        ${isDevAccount ? '' : '<input type="password" id="transferPassword" placeholder="M·∫≠t kh·∫©u v√≠" />'}
        <button onclick="handleTransfer()" id="transferBtn">üöÄ G·ª≠i giao d·ªãch</button>
        <div id="transferMessage"></div>
      `;
    }

    function renderHistoryTab() {
      const history = JSON.parse(localStorage.getItem('txHistory') || '[]');
      
      return `
        <h2>üìú L·ªãch s·ª≠ giao d·ªãch</h2>
        <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 15px;">üí° Click v√†o b·∫•t k·ª≥ giao d·ªãch n√†o ƒë·ªÉ xem chi ti·∫øt</p>
        
        <div class="search-box">
          <input type="text" id="searchTx" placeholder="T√¨m ki·∫øm theo hash ho·∫∑c address..." />
          <button onclick="searchTransaction()">üîç T√¨m</button>
        </div>
        
        ${history.length === 0 ? 
          '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">Ch∆∞a c√≥ giao d·ªãch n√†o</p>' :
          `<div style="overflow-x: auto;">
            <table>
              <thead>
                <tr>
                  <th>Th·ªùi gian</th>
                  <th>T·ª´</th>
                  <th>ƒê·∫øn</th>
                  <th style="text-align: right;">S·ªë ti·ªÅn</th>
                  <th style="text-align: center;">Tr·∫°ng th√°i</th>
                </tr>
              </thead>
              <tbody id="historyTableBody">
                ${renderHistoryRows(history)}
              </tbody>
            </table>
          </div>`
        }
      `;
    }

    function renderHistoryRows(history) {
      return history.map(tx => {
        const txJson = JSON.stringify(tx).replaceAll("'", "&#39;").replaceAll('"', "&quot;");
        return `
          <tr onclick='showTransactionDetail(${txJson})' style="cursor: pointer;">
            <td>${new Date(tx.timestamp).toLocaleString('vi-VN')}</td>
            <td class="address">${tx.from.slice(0, 10)}...</td>
            <td class="address">${tx.to.slice(0, 10)}...</td>
            <td style="text-align: right; font-weight: bold;">${tx.value} ETH</td>
            <td style="text-align: center;">
              <span class="status-badge ${tx.status === 'success' ? 'status-success' : 'status-failed'}">
                ${tx.status === 'success' ? '‚úì' : '‚úó'}
              </span>
            </td>
          </tr>
        `;
      }).join('');
    }

    function renderLogsTab() {
      const logs = JSON.parse(localStorage.getItem('gethLogs') || '[]');
      
      if (logs.length === 0) {
        return '<h2>üìä Backend Logs</h2><p style="text-align: center; color: var(--text-secondary); padding: 40px;">Ch∆∞a c√≥ log n√†o</p>';
      }

      return `
        <h2>üìä Backend Logs</h2>
        <div style="max-height: 500px; overflow-y: auto;">
          ${logs.map(log => `
            <div class="log-entry">
              <div class="log-header">
                <span style="color: #6366F1;">${log.event}</span>
                <span style="font-size: 12px; color: var(--text-secondary);">${new Date(log.timestamp).toLocaleString('vi-VN')}</span>
              </div>
              <div class="log-data">${JSON.stringify(log.data, null, 2)}</div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // ==================== ADDRESS VALIDATION ====================
    
    function validateTransferAddress() {
      const address = document.getElementById('transferTo').value.trim();
      const validationDiv = document.getElementById('addressValidation');
      const transferBtn = document.getElementById('transferBtn');
      
      if (!address) {
        validationDiv.innerHTML = '';
        showPhishingWarning([]);
        return;
      }

      const validation = validateAddress(address);
      
      if (validation.valid) {
        validationDiv.innerHTML = `
          <span class="validation-icon" style="color: #0D9488;">‚úÖ</span>
          <span style="color: #0D9488;">${validation.message}</span>
        `;
        
        // Ki·ªÉm tra phishing patterns
        const warnings = checkPhishingPattern(address);
        showPhishingWarning(warnings);
        
        if (warnings.length > 0) {
          transferBtn.disabled = false;
          transferBtn.style.background = 'linear-gradient(135deg, #F59E0B 0%, #D97706 100%)';
        } else {
          transferBtn.disabled = false;
          transferBtn.style.background = 'var(--button-primary)';
        }
        
        calculateGasFee();
      } else {
        validationDiv.innerHTML = `
          <span class="validation-icon" style="color: #DC2626;">‚ùå</span>
          <span style="color: #DC2626;">${validation.message}</span>
          ${validation.corrected ? `<br><small style="color: var(--text-secondary); margin-left: 26px;">ƒê·ªãa ch·ªâ ƒë√∫ng: ${validation.corrected}</small>` : ''}
        `;
        showPhishingWarning([]);
        transferBtn.disabled = true;
        document.getElementById('gasFeeDisplay').innerHTML = '';
      }
    }

    // ==================== MODAL FUNCTIONS ====================
    
    function showTransactionDetail(tx) {
      const modal = document.getElementById('txDetailModal');
      const modalBody = document.getElementById('modalBody');
      
      modalBody.innerHTML = `
        <div class="detail-row">
          <span class="detail-label">üîó Transaction Hash:</span>
          <span class="detail-value" style="display: flex; align-items: center; justify-content: flex-end;">
            <span style="word-break: break-all; margin-right: 8px;">${tx.hash || 'N/A'}</span>
            ${tx.hash ? `<button class="copy-btn" onclick="event.stopPropagation(); copyToClipboard('${tx.hash}', this)" title="Copy hash">üìã</button>` : ''}
          </span>
        </div>
        <div class="detail-row">
          <span class="detail-label">üì§ T·ª´:</span>
          <span class="detail-value" style="word-break: break-all;">${tx.from}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">üì• ƒê·∫øn:</span>
          <span class="detail-value" style="word-break: break-all;">${tx.to}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">üí∞ S·ªë ti·ªÅn:</span>
          <span class="detail-value" style="color: #4B5EAA; font-weight: bold;">${tx.value} ETH</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">‚õΩ Gas Fee:</span>
          <span class="detail-value">${tx.gasFee || 'N/A'} ETH</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">‚ö° Gas Price:</span>
          <span class="detail-value">${tx.gasPrice || 'N/A'} Gwei</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">üì¶ Block Number:</span>
          <span class="detail-value">${tx.blockNumber || 'N/A'}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">üïê Th·ªùi gian:</span>
          <span class="detail-value">${new Date(tx.timestamp).toLocaleString('vi-VN')}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">‚úÖ Tr·∫°ng th√°i:</span>
          <span class="detail-value">
            <span class="status-badge ${tx.status === 'success' ? 'status-success' : 'status-failed'}">
              ${tx.status === 'success' ? '‚úì Th√†nh c√¥ng' : '‚úó Th·∫•t b·∫°i'}
            </span>
          </span>
        </div>
      `;
      
      modal.classList.add('show');
    }

    function closeModal() {
      const modal = document.getElementById('txDetailModal');
      modal.classList.remove('show');
    }

    function copyToClipboard(text, button) {
      navigator.clipboard.writeText(text).then(() => {
        const originalText = button.innerHTML;
        button.innerHTML = '‚úì';
        button.classList.add('copied');
        
        setTimeout(() => {
          button.innerHTML = originalText;
          button.classList.remove('copied');
        }, 2000);
      }).catch(err => {
        console.error('Copy failed:', err);
        alert('Kh√¥ng th·ªÉ copy: ' + err.message);
      });
    }

    globalThis.addEventListener('click', function(event) {
      const modal = document.getElementById('txDetailModal');
      if (event.target === modal) {
        closeModal();
      }
    });

    function toggleBalanceVisibility() {
      balanceVisible = !balanceVisible;
      updateBalanceDisplay();
    }

    function updateBalanceDisplay() {
      const balanceEl = document.getElementById('currentBalance');
      if (!balanceEl) return;
      
      if (balanceVisible) {
        balanceEl.textContent = currentBalanceValue + ' ETH';
        balanceEl.classList.remove('balance-hidden');
      } else {
        balanceEl.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
        balanceEl.classList.add('balance-hidden');
      }
    }

    // ==================== EVENT HANDLERS ====================
    
    function switchAuthMode(mode) {
      localStorage.setItem('authMode', mode);
      render();
    }

    function switchTab(tab) {
      localStorage.setItem('dashboardTab', tab);
      const content = document.getElementById('tabContent');
      
      if (tab === 'balance') content.innerHTML = renderBalanceTab();
      else if (tab === 'chart') {
        content.innerHTML = renderChartTab();
        setTimeout(() => renderBalanceChart(), 100);
      }
      else if (tab === 'transfer') content.innerHTML = renderTransferTab();
      else if (tab === 'history') content.innerHTML = renderHistoryTab();
      else if (tab === 'logs') content.innerHTML = renderLogsTab();
    }

    // ==================== CHART FUNCTIONS ====================
    
    let balanceChartInstance = null;
    
    async function renderBalanceChart() {
      const canvas = document.getElementById('balanceChart');
      const messageEl = document.getElementById('chartLoadingMessage');
      if (!canvas) return;
      
      const history = getBalanceHistory(currentAccount);
      
      if (history.length === 0) {
        if (messageEl) {
          messageEl.innerHTML = '<div class="message info">‚è≥ ƒêang kh·ªüi t·∫°o d·ªØ li·ªáu bi·ªÉu ƒë·ªì...</div>';
        }
        
        try {
          const balance = await getBalance(currentAccount);
          saveBalanceHistory(currentAccount, balance);
          setTimeout(() => renderBalanceChart(), 500);
          return;
        } catch (err) {
          canvas.parentElement.innerHTML = '<p style="text-align: center; color: #DC2626; padding: 40px;">‚ùå L·ªói t·∫£i d·ªØ li·ªáu: ' + err.message + '</p>';
          return;
        }
      }

      if (messageEl) {
        messageEl.innerHTML = '';
      }

      if (balanceChartInstance) {
        balanceChartInstance.destroy();
      }

      const ctx = canvas.getContext('2d');
      const root = document.documentElement;
      const theme = root.dataset.theme || 'light';
      const gridColor = theme === 'dark' ? 'rgba(75, 85, 99, 0.3)' : 'rgba(0, 0, 0, 0.05)';
      const textColor = theme === 'dark' ? '#D1D5DB' : '#6B7280';
      
      const labels = history.map(item => {
        const date = new Date(item.timestamp);
        return date.toLocaleString('vi-VN', { 
          month: 'short', 
          day: 'numeric', 
          hour: '2-digit', 
          minute: '2-digit' 
        });
      });
      
      const data = history.map(item => item.balance);

      balanceChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'S·ªë d∆∞ (ETH)',
            data: data,
            borderColor: '#6366F1',
            backgroundColor: 'rgba(99, 102, 241, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointRadius: 4,
            pointHoverRadius: 6,
            pointBackgroundColor: '#6366F1',
            pointBorderColor: '#FFFFFF',
            pointBorderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                font: { size: 14, weight: 'bold' },
                color: textColor
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#FFFFFF',
              bodyColor: '#FFFFFF',
              padding: 12,
              cornerRadius: 8,
              displayColors: false,
              callbacks: {
                label: function(context) {
                  return 'S·ªë d∆∞: ' + context.parsed.y.toFixed(6) + ' ETH';
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: false,
              ticks: {
                callback: function(value) {
                  return value.toFixed(4) + ' ETH';
                },
                color: textColor,
                font: { size: 12 }
              },
              grid: {
                color: gridColor
              }
            },
            x: {
              ticks: {
                maxRotation: 45,
                minRotation: 45,
                color: textColor,
                font: { size: 11 }
              },
              grid: {
                display: false
              }
            }
          }
        }
      });
    }

    async function refreshChart() {
      const balance = await getBalance(currentAccount);
      saveBalanceHistory(currentAccount, balance);
      renderBalanceChart();
    }

    function clearChartHistory() {
      if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ bi·ªÉu ƒë·ªì?')) {
        const historyKey = `balanceHistory_${currentAccount}`;
        localStorage.removeItem(historyKey);
        renderBalanceChart();
      }
    }

    // ==================== TRANSACTION FUNCTIONS ====================
    
    async function calculateGasFee() {
      const to = document.getElementById('transferTo').value;
      const amount = document.getElementById('transferAmount').value;
      const displayEl = document.getElementById('gasFeeDisplay');

      if (!to || !amount || amount <= 0) {
        displayEl.innerHTML = '';
        return;
      }

      // Validate address first
      const validation = validateAddress(to);
      if (!validation.valid) {
        return;
      }

      try {
        const gasInfo = await estimateGasFee(currentAccount, to, amount);
        displayEl.innerHTML = `
          <div class="gas-fee-box">
            <div style="font-weight: bold; margin-bottom: 10px; color: var(--text-primary);">‚õΩ Chi ph√≠ giao d·ªãch</div>
            <div class="gas-fee-row">
              <span>Gas Price:</span>
              <span>${Number.parseFloat(gasInfo.gasPrice).toFixed(2)} Gwei</span>
            </div>
            <div class="gas-fee-row">
              <span>Gas Limit:</span>
              <span>${gasInfo.gasLimit}</span>
            </div>
            <div class="gas-fee-row">
              <span>Gas Fee:</span>
              <span>${Number.parseFloat(gasInfo.gasFee).toFixed(6)} ETH</span>
            </div>
            <div class="gas-fee-row total">
              <span>T·ªïng c·ªông:</span>
              <span>${gasInfo.total} ETH</span>
            </div>
          </div>
        `;
      } catch (err) {
        displayEl.innerHTML = `<div class="message error">‚ùå ${err.message}</div>`;
      }
    }

    function searchTransaction() {
      const searchTerm = document.getElementById('searchTx').value.toLowerCase().trim();
      const history = JSON.parse(localStorage.getItem('txHistory') || '[]');
      
      if (!searchTerm) {
        document.getElementById('historyTableBody').innerHTML = renderHistoryRows(history);
        return;
      }

      const filtered = history.filter(tx => 
        tx.hash.toLowerCase().includes(searchTerm) ||
        tx.from.toLowerCase().includes(searchTerm) ||
        tx.to.toLowerCase().includes(searchTerm)
      );

      const tbody = document.getElementById('historyTableBody');
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px; color: var(--text-secondary);">Kh√¥ng t√¨m th·∫•y giao d·ªãch n√†o</td></tr>';
      } else {
        tbody.innerHTML = renderHistoryRows(filtered);
      }
    }

    // ==================== AUTH HANDLERS ====================
    
    async function handleRegister() {
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const messageEl = document.getElementById('authMessage');

      if (password.length < 6) {
        messageEl.innerHTML = '<div class="message error">‚ùå M·∫≠t kh·∫©u ph·∫£i ‚â• 6 k√Ω t·ª±</div>';
        return;
      }
      if (password !== confirmPassword) {
        messageEl.innerHTML = '<div class="message error">‚ùå M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp</div>';
        return;
      }

      messageEl.innerHTML = '<div class="message info">‚è≥ ƒêang t·∫°o t√†i kho·∫£n...</div>';

      try {
        const { address, encrypted } = await createAccount(password);
        
        const accounts = JSON.parse(localStorage.getItem('walletAccounts') || '[]');
        accounts.push({
          address,
          encrypted,
          createdAt: new Date().toISOString(),
          type: 'user'
        });
        localStorage.setItem('walletAccounts', JSON.stringify(accounts));

        messageEl.innerHTML = `<div class="message success">‚úÖ T·∫°o t√†i kho·∫£n th√†nh c√¥ng!<br><small>${address}</small></div>`;
        
        setTimeout(() => {
          currentAccount = address;
          localStorage.setItem('currentAccount', address);
          currentPage = 'dashboard';
          render();
          loadBalance();
        }, 1500);
      } catch (err) {
        messageEl.innerHTML = `<div class="message error">‚ùå L·ªói: ${err.message}</div>`;
      }
    }

    async function handleImportDevAccount() {
      const messageEl = document.getElementById('authMessage');
      messageEl.innerHTML = '<div class="message info">‚è≥ ƒêang import dev account...</div>';

      try {
        const { address, balance } = await importDevAccount();
        
        const accounts = JSON.parse(localStorage.getItem('walletAccounts') || '[]');
        const existing = accounts.find(a => a.address.toLowerCase() === address.toLowerCase());
        
        if (existing) {
          messageEl.innerHTML = `<div class="message info">‚ÑπÔ∏è Dev account ƒë√£ t·ªìn t·∫°i!<br>üìç ${address}<br>üí∞ S·ªë d∆∞: ${balance} ETH</div>`;
          
          setTimeout(() => {
            currentAccount = address;
            localStorage.setItem('currentAccount', address);
            currentPage = 'dashboard';
            render();
            loadBalance();
          }, 2000);
          return;
        }
        
        accounts.push({
          address,
          type: 'dev',
          createdAt: new Date().toISOString()
        });
        localStorage.setItem('walletAccounts', JSON.stringify(accounts));

        messageEl.innerHTML = `<div class="message success">‚úÖ Import th√†nh c√¥ng!<br>üìç ${address}<br>üí∞ S·ªë d∆∞: ${balance} ETH<br>üîì Kh√¥ng c·∫ßn m·∫≠t kh·∫©u (qu·∫£n l√Ω b·ªüi Geth)</div>`;
        
        setTimeout(() => {
          currentAccount = address;
          localStorage.setItem('currentAccount', address);
          currentPage = 'dashboard';
          render();
          loadBalance();
        }, 2000);
      } catch (err) {
        messageEl.innerHTML = `<div class="message error">‚ùå L·ªói: ${err.message}</div>`;
      }
    }

    async function handleLogin() {
      const address = document.getElementById('loginAddress').value;
      const password = document.getElementById('loginPassword').value;
      const messageEl = document.getElementById('authMessage');

      if (!address || !password) {
        messageEl.innerHTML = '<div class="message error">‚ùå Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin</div>';
        return;
      }

      messageEl.innerHTML = '<div class="message info">‚è≥ ƒêang ƒëƒÉng nh·∫≠p...</div>';

      try {
        const accounts = JSON.parse(localStorage.getItem('walletAccounts') || '[]');
        const account = accounts.find(a => a.address.toLowerCase() === address.toLowerCase());
        
        if (!account) {
          messageEl.innerHTML = '<div class="message error">‚ùå T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i</div>';
          return;
        }

        if (account.type !== 'dev') {
          web3.eth.accounts.decrypt(JSON.parse(account.encrypted), password);
        }
        
        logToBackend('LOGIN_SUCCESS', { address });
        messageEl.innerHTML = '<div class="message success">‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng!</div>';
        
        setTimeout(() => {
          currentAccount = address;
          localStorage.setItem('currentAccount', address);
          currentPage = 'dashboard';
          render();
          loadBalance();
        }, 1000);
      } catch (err) {
        messageEl.innerHTML = '<div class="message error">‚ùå Sai m·∫≠t kh·∫©u!</div>';
        logToBackend('LOGIN_FAILED', { address, error: err.message });
      }
    }

    function handleLogout() {
      if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t?')) {
        currentAccount = null;
        localStorage.removeItem('currentAccount');
        currentPage = 'login';
        render();
      }
    }

    async function loadBalance() {
      if (!currentAccount) return;
      
      try {
        const restored = await restoreBalanceIfNeeded(currentAccount);
        if (restored) {
          await new Promise(resolve => setTimeout(resolve, 2000));
        }
        
        const balance = await getBalance(currentAccount);
        const formattedBalance = Number.parseFloat(balance).toFixed(6);
        
        currentBalanceValue = formattedBalance;
        
        const balanceEl = document.getElementById('currentBalance');
        if (balanceEl) {
          if (balanceVisible) {
            balanceEl.textContent = formattedBalance + ' ETH';
            balanceEl.classList.remove('balance-hidden');
          } else {
            balanceEl.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            balanceEl.classList.add('balance-hidden');
          }
        }
        
        saveCurrentBalance(currentAccount, balance);
        saveBalanceHistory(currentAccount, balance);
      } catch (err) {
        console.error('L·ªói load balance:', err);
      }
    }

    async function checkBalance() {
      const address = document.getElementById('checkAddress').value;
      const resultEl = document.getElementById('balanceResult');

      if (!address) {
        resultEl.innerHTML = '<div class="message error">‚ùå Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ</div>';
        return;
      }

      const validation = validateAddress(address);
      if (!validation.valid) {
        resultEl.innerHTML = `<div class="message error">${validation.message}</div>`;
        return;
      }

      resultEl.innerHTML = '<div class="message info">‚è≥ ƒêang ki·ªÉm tra...</div>';

      try {
        const balance = await getBalance(address);
        const formattedBalance = Number.parseFloat(balance).toFixed(6);
        resultEl.innerHTML = `
          <div class="message success">
            üí∞ S·ªë d∆∞: <strong>${formattedBalance} ETH</strong>
            <div class="security-badge verified" style="margin-top: 10px;">
              ‚úÖ ƒê·ªãa ch·ªâ h·ª£p l·ªá (Checksum ƒë√£ x√°c th·ª±c)
            </div>
          </div>
        `;
      } catch (err) {
        resultEl.innerHTML = `<div class="message error">‚ùå L·ªói: ${err.message}</div>`;
      }
    }

    async function handleTransfer() {
      const to = document.getElementById('transferTo').value.trim();
      const amount = document.getElementById('transferAmount').value;
      const passwordInput = document.getElementById('transferPassword');
      const password = passwordInput ? passwordInput.value : '';
      const messageEl = document.getElementById('transferMessage');

      const accounts = JSON.parse(localStorage.getItem('walletAccounts') || '[]');
      const currentAcc = accounts.find(a => a.address.toLowerCase() === currentAccount.toLowerCase());
      const isDevAccount = currentAcc && currentAcc.type === 'dev';

      if (!to || !amount) {
        messageEl.innerHTML = '<div class="message error">‚ùå Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin</div>';
        return;
      }

      const validation = validateAddress(to);
      if (!validation.valid) {
        messageEl.innerHTML = `<div class="message error">‚ùå ${validation.message}</div>`;
        return;
      }

      const warnings = checkPhishingPattern(to);
      if (warnings.length > 0) {
        const confirmed = confirm('‚ö†Ô∏è C·∫¢NH B√ÅO B·∫¢O M·∫¨T!\n\n' + warnings.join('\n') + '\n\nB·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ti·∫øp t·ª•c?');
        if (!confirmed) {
          messageEl.innerHTML = '<div class="message warning">üõ°Ô∏è Giao d·ªãch ƒë√£ b·ªã h·ªßy v√¨ l√Ω do b·∫£o m·∫≠t</div>';
          return;
        }
      }

      if (!isDevAccount && !password) {
        messageEl.innerHTML = '<div class="message error">‚ùå Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u</div>';
        return;
      }

      const checksumTo = web3.utils.toChecksumAddress(to);
      const confirmMsg = `üîê X√ÅC NH·∫¨N GIAO D·ªäCH\n\n` +
        `T·ª´: ${currentAccount}\n` +
        `ƒê·∫øn: ${checksumTo}\n` +
        `S·ªë ti·ªÅn: ${amount} ETH\n\n` +
        `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën th·ª±c hi·ªán giao d·ªãch n√†y?`;
      
      if (!confirm(confirmMsg)) {
        messageEl.innerHTML = '<div class="message info">‚ùå Giao d·ªãch ƒë√£ b·ªã h·ªßy</div>';
        return;
      }

      messageEl.innerHTML = '<div class="message info">‚è≥ ƒêang g·ª≠i giao d·ªãch...</div>';

      try {
        const receipt = await sendTransaction(currentAccount, checksumTo, amount, password);
        
        const history = JSON.parse(localStorage.getItem('txHistory') || '[]');
        history.unshift({
          hash: receipt.transactionHash,
          from: currentAccount,
          to: checksumTo,
          value: amount,
          blockNumber: receipt.blockNumber,
          gasFee: receipt.gasFee,
          gasPrice: receipt.gasPrice,
          status: receipt.status ? 'success' : 'failed',
          timestamp: new Date().toISOString()
        });
        localStorage.setItem('txHistory', JSON.stringify(history));

        const txJson = JSON.stringify(history[0]).replaceAll("'", "&#39;").replaceAll('"', "&quot;");
        messageEl.innerHTML = `
          <div class="message success">
            ‚úÖ Th√†nh c√¥ng!<br>
            <small>Hash: ${receipt.transactionHash}</small><br>
            <div class="security-badge verified" style="display: inline-flex; margin-top: 10px;">
              üîí Giao d·ªãch ƒë√£ ƒë∆∞·ª£c x√°c th·ª±c v√† ghi v√†o blockchain
            </div><br>
            <button onclick='showTransactionDetail(${txJson})' 
                    style="margin-top: 10px; width: auto; padding: 8px 16px;">
              üîç Xem chi ti·∫øt
            </button>
          </div>
        `;
        
        document.getElementById('transferTo').value = '';
        document.getElementById('transferAmount').value = '';
        if (passwordInput) passwordInput.value = '';
        document.getElementById('gasFeeDisplay').innerHTML = '';
        document.getElementById('addressValidation').innerHTML = '';
        showPhishingWarning([]);
        
        await loadBalance();
        
        if (localStorage.getItem('dashboardTab') === 'chart') {
          setTimeout(() => refreshChart(), 1000);
        }
      } catch (err) {
        messageEl.innerHTML = `<div class="message error">‚ùå L·ªói: ${err.message}</div>`;
        
        logToBackend('TRANSACTION_FAILED', {
          from: currentAccount,
          to: checksumTo,
          amount: amount,
          error: err.message,
          timestamp: new Date().toISOString()
        });
      }
    }

    void async function() {
      initTheme();
      
      const connected = await initWeb3();
      
      if (!connected) {
        document.getElementById('app').innerHTML = `
          <div class="card" style="max-width: 600px; margin: 50px auto; text-align: center;">
            <h1 style="color: #DC2626;">‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi Geth</h1>
            <p style="margin: 20px 0;">Vui l√≤ng ki·ªÉm tra:</p>
            <ul style="text-align: left; padding-left: 40px;">
              <li>Geth ƒë√£ ch·∫°y: <code>geth --dev --http --http.api eth,net,web3 --http.corsdomain "*"</code></li>
              <li>RPC ƒëang l·∫Øng nghe t·∫°i: <code>http://127.0.0.1:8545</code></li>
              <li>CORS ƒë∆∞·ª£c b·∫≠t</li>
            </ul>
            <button onclick="location.reload()">üîÑ Th·ª≠ l·∫°i</button>
          </div>
        `;
        return;
      }

      const savedAccount = localStorage.getItem('currentAccount');
      if (savedAccount) {
        currentAccount = savedAccount;
        currentPage = 'dashboard';
      }

      render();
      
      if (currentPage === 'dashboard') {
        await loadBalance();
        switchTab(localStorage.getItem('dashboardTab') || 'balance');
        setInterval(loadBalance, 10000);
      }
    }();
  </script>
</body>
</html>